<!DOCTYPE html>
<html lang="it">
<head>
<link rel="icon" href="favicon.ico" sizes="any">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matchday – Petriolese Calcio</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{ --bg:#0b0c11; --fg:#e6ebf2; --muted:#9aa3b2; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; overflow:hidden; }
  /* wrapper a tutta pagina, centrato senza scroll (anche mobile) */
  #app{ display:grid; place-items:center; width:100%; height:100svh; }
  /* card di loading */
  .card{ max-width:min(740px,92vw); padding:24px; border-radius:14px; background:linear-gradient(180deg,#131722,#0b0c11); box-shadow:0 16px 60px rgba(0,0,0,.45); text-align:center }
  .muted{ color:var(--muted) }
  .spinner{ width:28px; height:28px; border-radius:50%; border:3px solid rgba(255,255,255,.18); border-top-color:#fff; animation:spin 1s linear infinite; margin:12px auto 0 }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  /* iframe che contiene la pagina (isolata) */
  #view{
    width: min(1200px, 96vw);
    height: min(96vh, 100svh);
    border: 0;
    border-radius: 18px;
    background: var(--bg);
    box-shadow: 0 16px 60px rgba(0,0,0,.45);
    display:none; opacity:0; transition:opacity .28s ease;
  }
  #view.ready{ display:block; opacity:1; }
  /* HUD debug */
  #hud{ position:fixed; inset:auto 12px 12px auto; background:rgba(0,0,0,.55); color:#fff; font:12px/1.3 ui-monospace,monospace; padding:8px 10px; border-radius:8px; backdrop-filter: blur(6px); display:none; white-space:pre; z-index:9999 }
  #hud.show{ display:block }
</style>
</head>
<body>
  <div id="app">
    <div class="card" id="status">
      <div style="font-weight:900; letter-spacing:.04em; text-transform:uppercase">Petriolese Calcio</div>
      <h1 style="margin:.35em 0 .2em">Caricamento…</h1>
      <div class="muted">Scelgo la vista giusta (countdown / lineup)</div>
      <div class="spinner"></div>
    </div>
    <iframe id="view" title="Matchday"></iframe>
  </div>
  <pre id="hud"></pre>

<script src="js/sheet-utils.js"></script>
<script>
/* ====== CONFIG ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const META_GID      = '254048258';
/* Incolla qui l’URL “Pubblica sul web” della scheda Meta come fallback CSV */
const PUBLISHED_META_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml';  // es: 'https://docs.google.com/spreadsheets/d/e/.../pubhtml?gid=254048258&single=true'

const ROUTES = {
  countdown: 'countdown.html',
  lineup:    'lineup.html',
  fulltime:  'fulltime.html'   // opzionale
};

const WINDOWS = {
  countdown_to_lineup: 5 * 60 * 1000,   // -5 min da KO
  lineup_to_fulltime:  3 * 60 * 60 * 1000  // +3h da KO
};

const Sheets = window.PetrioleseSheets;
if (!Sheets) {
  throw new Error('PetrioleseSheets utils not loaded');
}
const { fetchCsvPrefer, normalizeMeta, parseDateTimeIT } = Sheets;

/* ====== ROUTER (iframe) ====== */
function decideRoute(now, kickoff){
  const t=kickoff.getTime(), n=now.getTime();
  const Tm5 = t - WINDOWS.countdown_to_lineup;
  const Tp3 = t + WINDOWS.lineup_to_fulltime;
  if (n < Tm5) return 'countdown';
  if (n < Tp3) return 'lineup';
  return 'fulltime' in ROUTES ? 'fulltime' : 'countdown';
}
let currentRoute=null, kickoffCache=null, boundaryTimer=null, pollTimer=null;

function setIframeSrc(url){
  const status = document.getElementById('status');
  const frame  = document.getElementById('view');
  frame.classList.remove('ready');
  status.style.display='block';
  frame.onload = ()=>{ status.style.display='none'; frame.classList.add('ready'); };
  frame.src = url;
}

function scheduleBoundaryCheck(){
  if(!kickoffCache) return;
  clearTimeout(boundaryTimer);
  const now = Date.now();
  const tKO = kickoffCache.getTime();
  const t1  = tKO - WINDOWS.countdown_to_lineup;
  const t2  = tKO + WINDOWS.lineup_to_fulltime;
  const upcoming = [t1,t2].filter(t=>t>now).sort((a,b)=>a-b)[0];
  const delay = upcoming ? Math.max(500, Math.min(upcoming-now+250, 30*60*1000)) : 30*60*1000;
  boundaryTimer = setTimeout(()=> {
    const rNew = decideRoute(new Date(), kickoffCache);
    if(rNew !== currentRoute){ currentRoute = rNew; setIframeSrc(ROUTES[rNew]); }
    scheduleBoundaryCheck();
  }, delay);
}

async function startMetaPolling(ms=120000){
  clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const rows = await fetchCsvPrefer(SHEET_FILE_ID, META_GID, PUBLISHED_META_URL);
      const meta = normalizeMeta(rows);
      const dateStr = (meta.get('data')||meta.get('prossimadata')||meta.get('prossima_data')||'').toString().trim();
      const timeStr = (meta.get('ora') ||meta.get('prossimaora') ||meta.get('prossima_ora') ||'').toString().trim();
      const k = parseDateTimeIT(dateStr, timeStr);
      if(k && !isNaN(+k)){
        if(!kickoffCache || Math.abs(k.getTime() - kickoffCache.getTime()) > 60000){
          kickoffCache = k; scheduleBoundaryCheck();
        }
      }
    }catch(e){}
  }, ms);
}

(async function main(){
  const params = new URLSearchParams(location.search);
  const force  = (params.get('force')||'').toLowerCase();
  const debug  = params.get('debug') === '1';

  const hud = document.getElementById('hud');
  const rows = await fetchCsvPrefer(SHEET_FILE_ID, META_GID, PUBLISHED_META_URL);
  if(!rows.length){
    document.getElementById('status').innerHTML = `
      <div class="card">
        <h2>⚠️ Meta non raggiungibile</h2>
        <div class="muted">Controlla la pubblicazione CSV o incolla PUBLISHED_META_URL nello script.</div>
      </div>`;
    return;
  }
  const meta = normalizeMeta(rows);
  const dateStr = (meta.get('data')||meta.get('prossimadata')||meta.get('prossima_data')||'').toString().trim();
  const timeStr = (meta.get('ora') ||meta.get('prossimaora') ||meta.get('prossima_ora') ||'').toString().trim();
  const kickoff = parseDateTimeIT(dateStr, timeStr);
  if(kickoff && !isNaN(+kickoff)) kickoffCache = kickoff;

  let route = 'countdown';
  if (force && ROUTES[force]) route = force;
  else if (kickoffCache)      route = decideRoute(new Date(), kickoffCache);

  if (debug){
    hud.textContent = [
      `FORCE:   ${force||'-'}`,
      `ROUTE:   ${route}`,
      kickoffCache ? `KICKOFF: ${kickoffCache.toLocaleString('it-IT')}` : 'KICKOFF: n/d',
      `TARGET:  ${ROUTES[route]}`
    ].join('\n');
    hud.classList.add('show');
  }

  setIframeSrc(ROUTES[route]);
  scheduleBoundaryCheck();
  startMetaPolling(120000);

  // Mantieni root in barra
  try{ history.replaceState(null,'','./'); }catch(e){}
})();
</script>

<script>
  // Cache-busting: cambia questo valore a ogni rilascio
  const VERSION = '2025-09-05-1';

  const f = document.getElementById('view');
  if (f && f.src && f.src.endsWith('countdown.html')) {
    f.src = 'countdown.html?v=' + encodeURIComponent(VERSION);
  }
</script>

</body>
</html>
