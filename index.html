<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Index Router – Petriolese Calcio</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{ --bg:#0b0c11; --fg:#e6ebf2; --muted:#9aa3b2; }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; display:grid; place-items:center}
  .card{ max-width:min(740px,92vw); padding:24px; border-radius:14px; background:linear-gradient(180deg,#131722,#0b0c11); box-shadow:0 16px 60px rgba(0,0,0,.45); text-align:center }
  .muted{ color:var(--muted) }
  .spinner{ width:28px; height:28px; border-radius:50%; border:3px solid rgba(255,255,255,.18); border-top-color:#fff; animation:spin 1s linear infinite; margin:12px auto 0 }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Debug HUD (solo con ?debug=1) */
  #hud{ position:fixed; inset:auto 12px 12px auto; background:rgba(0,0,0,.55); color:#fff; font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; padding:8px 10px; border-radius:8px; backdrop-filter: blur(6px); display:none; white-space:pre; }
  #hud.show{ display:block }
  a.btn{ display:inline-block; margin-top:14px; padding:10px 14px; border-radius:10px; background:#fff; color:#111; text-decoration:none; font-weight:700 }
</style>
</head>
<body>
  <div class="card" id="status">
    <div style="font-weight:900; letter-spacing:.04em; text-transform:uppercase">Petriolese Calcio</div>
    <h1 style="margin:.35em 0 .2em">Caricamento…</h1>
    <div class="muted">Scelgo la pagina giusta (countdown / lineup)</div>
    <div class="spinner"></div>
  </div>

  <pre id="hud"></pre>

<script>
/* ====== CONFIG ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const META_GID      = '254048258';
const PUBLISHED_META_URL = ''; // opzionale fallback pubhtml -> CSV

// Rotte effettive presenti nel tuo repo
const ROUTES = {
  countdown: 'countdown.html',
  lineup:    'lineup.html',
  post:      'post.html' // non usata automaticamente (solo ?force=post)
};

// Finestre temporali (ms)
const WINDOWS = {
  countdown_to_lineup: 5 * 60 * 1000,   // 5 min prima del KO
  lineup_to_after:     3 * 60 * 60 * 1000 // 3 ore dopo il KO
};

/* ====== HELPERS (CSV Google) ====== */
const gvizCsvURL=(fileId,gid)=>`https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
function pubCsvURL(pubhtmlUrl){
  const u=new URL(pubhtmlUrl); const parts=u.pathname.split('/'); const idIdx=parts.findIndex(p=>p==='e')+1; const id=parts[idIdx]||'';
  const root=`${u.protocol}//${u.host}${parts.slice(0,idIdx).join('/')}/${id}`;
  return `${root}/pub?gid=${encodeURIComponent(u.searchParams.get('gid')||'0')}&single=true&output=csv`;
}
function parseCSV(text){
  let t=String(text||'').replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n');
  const lines=t.split('\n').filter((ln,i)=>i===0||ln.trim().length>0);
  if(!lines.length) return [];
  const rows=[]; let row=[],cur='',inQ=false;
  const pushCell=()=>{row.push(cur);cur=''}; const pushRow=()=>{rows.push(row);row=[]};
  const s=lines.join('\n');
  for(let i=0;i<s.length;i++){
    const c=s[i],n=s[i+1];
    if(inQ){ if(c=='"'&&n=='"'){cur+='"';i++} else if(c=='"'){inQ=false} else cur+=c }
    else{ if(c=='"') inQ=true; else if(c==',') pushCell(); else if(c=='\n'){pushCell();pushRow()} else cur+=c }
  }
  if(cur!==''||row.length){pushCell();pushRow()}
  const header=(rows.shift()||[]).map(h=>String(h||'').trim());
  return rows.map(r=>Object.fromEntries(header.map((h,i)=>[h, r[i]!==undefined?r[i]:'' ])));
}
async function fetchCsvPrefer(fileId,gid,pubUrl){
  try{ const res=await fetch(gvizCsvURL(fileId,gid),{cache:'no-store'}); if(res.ok){ return parseCSV(await res.text()); } }catch(e){}
  if(pubUrl){ const res=await fetch(pubCsvURL(pubUrl),{cache:'no-store'}); return parseCSV(await res.text()); }
  return [];
}
function normalizeMeta(rows){
  const m=new Map();
  rows.forEach(r=>{
    const k=(''+(r.Key||r.KEY||'')).trim().toLowerCase();
    const v=(''+(r.Value||r.VALORE||'')).trim();
    if(k) m.set(k,v);
  });
  return m;
}
function parseDateTimeIT(dateStr, timeStr){
  const s = String(dateStr||'').trim();
  const t = String(timeStr||'').trim();
  if(!s) return null;
  const combined = s.includes(':') ? s : (t ? `${s} ${t}` : s);
  const m1 = combined.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:[ T](\d{1,2}):(\d{2}))?$/);
  const m2 = combined.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2}))?$/);
  let y,M,d,h=15,min=0;
  if(m1){ d=+m1[1]; M=+m1[2]-1; y=+m1[3]; if(m1[4]){h=+m1[4]; min=+m1[5];} }
  else if(m2){ y=+m2[1]; M=+m2[2]-1; d=+m2[3]; if(m2[4]){h=+m2[4]; min=+m2[5];} }
  else return new Date(s);
  return new Date(y,M,d,h,min,0,0);
}

/* ====== ROUTING ====== */
function decideRoute(now, kickoff){
  const t  = kickoff.getTime();
  const n  = now.getTime();
  const T_minus_5m = t - WINDOWS.countdown_to_lineup; // -5 min
  const T_plus_3h  = t + WINDOWS.lineup_to_after;     // +3 h

  if (n < T_minus_5m) return 'countdown'; // fino a 5 min prima
  if (n < T_plus_3h)  return 'lineup';    // da -5 min a +3 h
  return 'countdown';                      // dopo +3 h → di nuovo countdown
}

function navigateTo(url){ location.replace(url); }

/* ====== MAIN ====== */
(async function main(){
  const params = new URLSearchParams(location.search);
  const force  = (params.get('force')||'').toLowerCase(); // countdown|lineup|post
  const debug  = params.get('debug') === '1';

  const hudEl = document.getElementById('hud');
  const statusEl = document.getElementById('status');

  // Force route (se valida)
  if (force && ROUTES[force]) {
    if (debug) { hudEl.textContent = `FORCE=${force}\n→ ${ROUTES[force]}`; hudEl.classList.add('show'); }
    navigateTo(ROUTES[force]);
    return;
  }

  // Leggi Meta
  let metaRows = [];
  try { metaRows = await fetchCsvPrefer(SHEET_FILE_ID, META_GID, PUBLISHED_META_URL); } catch(e){}

  if (!metaRows.length) {
    statusEl.innerHTML = `
      <div class="card">
        <h2>⚠️ Dati non disponibili</h2>
        <div class="muted">Impossibile leggere la scheda “Meta”.</div>
        <a class="btn" href="${ROUTES.countdown}">Apri il Countdown</a>
      </div>`;
    return;
  }

  const meta    = normalizeMeta(metaRows);
  const dateStr = (meta.get('data')||meta.get('prossimadata')||meta.get('prossima_data')||'').toString().trim();
  const timeStr = (meta.get('ora') ||meta.get('prossimaora') ||meta.get('prossima_ora') ||'').toString().trim();

  const kickoff = parseDateTimeIT(dateStr, timeStr);
  if (!kickoff || isNaN(+kickoff)) {
    statusEl.innerHTML = `
      <div class="card">
        <h2>⚠️ Data/Ora non impostate</h2>
        <div class="muted">Compila “Data” e “Ora” nella scheda Meta.</div>
        <a class="btn" href="${ROUTES.countdown}">Apri il Countdown</a>
      </div>`;
    return;
  }

  const now   = new Date();
  const route = decideRoute(now, kickoff);
  const url   = ROUTES[route] || ROUTES.countdown;

  if (debug) {
    const lines = [
      `NOW:     ${now.toLocaleString('it-IT')}`,
      `KICKOFF: ${kickoff.toLocaleString('it-IT')}`,
      `ROUTE:   ${route}`,
      `TARGET:  ${url}`,
      '',
      `WINDOWS:`,
      `  countdown_to_lineup: ${WINDOWS.countdown_to_lineup/60000} min`,
      `  lineup_to_after:     ${WINDOWS.lineup_to_after/3600000} h`,
      '',
      `URLS: ${JSON.stringify(ROUTES,null,2)}`
    ].join('\n');
    hudEl.textContent = lines;
    hudEl.classList.add('show');
    setTimeout(()=>navigateTo(url), 1000);
  } else {
    navigateTo(url);
  }
})();
</script>
</body>
</html>
