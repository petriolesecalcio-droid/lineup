<!DOCTYPE html>
<html lang="it">
<head>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Petriolese — Matchday</title>
<meta name="theme-color" content="#0b0f0c">
<link rel="preconnect" href="https://docs.google.com">
<link rel="dns-prefetch" href="https://docs.google.com">

<!-- html2canvas per la cattura PNG -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --club-red:#e11d48; --club-blue:#1d4ed8;
    --bench:var(--club-blue);
    --bg:#0b0f0c; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
  img{max-width:100%;height:auto}

  /* ===== TOPBAR (tutto su una riga centrata) ===== */
  .topbar{
    width:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    padding:10px 12px;
    border-bottom:2px solid rgba(29,78,216,.35)
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:42px;height:42px;object-fit:contain}
  .brand .club{font-weight:900;letter-spacing:.3px;white-space:nowrap}
  .vs-img{height:26px;width:auto;display:block}
  .opponent{font-weight:900;text-transform:uppercase;white-space:nowrap}
  .matchline{display:none}
  .subline{display:none}
  @media (max-width:520px){
    .brand .club{font-size:14px}
    .vs-img{height:22px}
    .opponent{font-size:14px}
  }

  /* ===== Toolbar condivisione: sinistra icone, destra link IG ===== */
  .toolbar{
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)
  }
  .tools-left{display:flex;gap:12px;align-items:center}
  .tools-right{display:flex;gap:8px;align-items:center}
  .iconbtn{
    display:inline-flex;align-items:center;justify-content:center;
    width:44px;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);cursor:pointer;padding:8px;
  }
  .iconbtn:hover{filter:brightness(1.08)}
  .iconbtn svg{width:24px;height:24px;display:block}
  .ig-link{
    display:inline-flex;align-items:center;gap:8px;
    background:transparent;border:1px solid rgba(255,255,255,.18);
    color:#fff;border-radius:12px;padding:8px 12px;text-decoration:none;font-weight:800;
  }
  .ig-link:hover{filter:brightness(1.08)}
  .ig-link svg{width:18px;height:18px}

  .wrap{min-height:100svh;display:grid;place-items:start center;padding:8px 16px calc(16px + env(safe-area-inset-bottom))}
  .board{display:grid;gap:16px;grid-template-columns:1fr;width:100%;max-width:960px}
  @media (min-width:860px){.board{grid-template-columns:minmax(300px,520px) 1fr;align-items:start;gap:20px}}

  /* Blocchi catturabili (senza header: lo disegniamo in overlay in fase di share) */
  .capture{background:#0b0f0c;padding:10px;border-radius:16px;border:1px solid rgba(255,255,255,.06)}

  .pitch{position:relative;width:100%;max-width:520px;aspect-ratio:2/3;margin:0 auto;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.30);overflow:hidden;border:2px solid rgba(29,78,216,.25)}
  .pitch>img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  .player{position:absolute;transform:translate(-50%,-50%);width:clamp(60px,11.5vw,96px);height:clamp(60px,11.5vw,96px);overflow:visible}
  .player .ball{width:100%;height:100%;border-radius:999px;overflow:hidden;border:2px solid rgba(255,255,255,.7);box-shadow:0 6px 16px rgba(0,0,0,.35);background:linear-gradient(90deg,var(--club-red) 0 50%,var(--club-blue) 50% 100%);display:grid;place-items:center;padding:4px}
  .player .ball img{width:100%;height:100%;object-fit:cover;display:block}
  .num-badge{position:absolute;left:50%;transform:translate(-50%,-100%);top:0;background:var(--club-blue);color:#fff;border:2px solid rgba(255,255,255,.7);border-radius:999px;padding:2px 7px;font-weight:900;font-size:12px;line-height:1;z-index:2}
  .name-below{position:absolute;top:calc(100% - 4px);left:50%;transform:translateX(-50%);background:var(--club-blue);color:#fff;border:2px solid rgba(255,255,255,.7);border-radius:999px;padding:3px 8px;font-weight:900;font-size:12px;line-height:1;white-space:nowrap;overflow:visible;max-width:none;box-shadow:0 2px 8px rgba(0,0,0,.25)}

  .side{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .title{font-weight:800;letter-spacing:.2px;font-size:14px;color:#fff}

  /* Panchina */
  .bench{display:grid;grid-template-columns:repeat(auto-fit,minmax(clamp(84px,22vw,140px),1fr));gap:14px;justify-content:center;max-width:min(100%,520px);margin:8px auto 0}
  .bench .item{display:grid;grid-template-rows:auto auto;justify-items:center;gap:6px;position:relative;overflow:visible}
  .bench .avatar-wrap{position:relative;overflow:visible;display:grid;place-items:center}
  .bench .avatar{width:clamp(64px,18vw,110px);height:clamp(64px,18vw,110px);border-radius:999px;overflow:hidden;background:var(--bench);border:2px solid rgba(255,255,255,.55);box-shadow:0 4px 12px rgba(0,0,0,.25);display:grid;place-items:center}
  .bench .avatar img{width:100%;height:100%;object-fit:cover}
  /* Numero FUORI dal cerchio, in alto a destra, ma sempre visibile */
  .bench .num-out{
    position:absolute; top:-6px; right:-6px;
    background:var(--club-blue); color:#fff; border:2px solid rgba(255,255,255,.7);
    border-radius:999px; padding:3px 8px; font-weight:900; font-size:12px; line-height:1; z-index:3;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.45));
  }
  .bench .name{font-size:12px;text-align:center;color:#e5e7eb;white-space:normal;word-break:break-word;line-height:1.05}

  .notice{font-size:12px;color:var(--muted);text-align:center;margin-top:2px}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <img id="clubLogo" src="logo.png" alt="Logo Petriolese" onerror="this.style.display='none'"/>
    <div class="club">Petriolese Calcio</div>
  </div>
  <img class="vs-img" src="vs_battle.png" alt="VS" />
  <div id="opponentInline" class="opponent">AVVERSARIO</div>

  <!-- blocco originale (nascosto per compatibilità) -->
  <div>
    <div class="matchline" id="matchLine">PETRIOLESE vs AVVERSARIO</div>
    <div class="subline" id="matchWhen"></div>
  </div>
</header>

<!-- TOOLBAR: sinistra condivisione, destra link IG -->
<div class="toolbar">
  <div class="tools-left">
    <!-- Instagram (apre menu formati) -->
    <button class="iconbtn" id="btnIG" title="Instagram" aria-label="Condividi su Instagram">
      <!-- Material-like Instagram -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="18" height="18" rx="5"></rect>
        <circle cx="12" cy="12" r="3.5"></circle>
        <circle cx="17.2" cy="6.8" r="1.2" fill="currentColor" stroke="none"></circle>
      </svg>
    </button>
    <!-- Facebook -->
    <button class="iconbtn" id="btnFB" title="Facebook" aria-label="Condividi su Facebook">
      <!-- Material-like Facebook -->
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M13.5 9H15V6.5h-1.5A3.5 3.5 0 0 0 10 10v2H8v2.5h2V21h3v-6h2l.5-2.5H13v-2a1 1 0 0 1 1-1Z"/>
        <rect x="2" y="2" width="20" height="20" rx="5" fill="none" stroke="currentColor" stroke-width="1.2"/>
      </svg>
    </button>
    <!-- Condividi nativo / Collage -->
    <button class="iconbtn" id="btnShare" title="Condividi" aria-label="Condividi">
      <!-- Material-like Share -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="18" cy="5" r="3"></circle>
        <circle cx="6" cy="12" r="3"></circle>
        <circle cx="18" cy="19" r="3"></circle>
        <path d="M8.9 10.9l6.2-3.6M8.9 13.1l6.2 3.6"></path>
      </svg>
    </button>
  </div>
  <div class="tools-right">
    <a class="ig-link" href="https://www.instagram.com/asd_petriolese_calcio/" target="_blank" rel="noopener">
      <!-- piccolo logo IG -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="18" height="18" rx="5"></rect>
        <circle cx="12" cy="12" r="3.2"></circle>
        <circle cx="17.2" cy="6.8" r="1.1" fill="currentColor" stroke="none"></circle>
      </svg>
      VISITA IL NOSTRO IG
    </a>
  </div>
</div>

<main class="wrap">
  <section class="board">
    <div>
      <!-- Sezione catturabile per Instagram: XI TITOLARI (senza intestazione) -->
      <section class="capture" id="capture-xi">
        <div class="pitch" id="pitch">
          <img id="pitchImg" src="https://tse3.mm.bing.net/th/id/OIP.xR8peX5FCoXBMSXQkppsfwAAAA?pid=Api" alt="Mezzo campo" loading="lazy" decoding="async"/>
        </div>
      </section>
    </div>

    <aside class="side">
      <div class="card">
        <!-- Sezione catturabile per Instagram: PANCHINA (senza intestazione) -->
        <section class="capture" id="capture-bench">
          <div class="bench" id="bench"></div>
        </section>

        <div class="notice" id="notice">Carico i dati…</div>
      </div>
    </aside>
  </section>
</main>

<!-- Modal Instagram: scelta formato -->
<div class="modal" id="igModal" aria-hidden="true">
  <div class="box">
    <h3>Condividi su Instagram</h3>
    <div>Seleziona il formato:</div>
    <div class="row">
      <button id="igStoryBtn">Storia (1080×1920)</button>
      <button id="igFeedBtn">Feed/Reel (1080×1350)</button>
    </div>
    <small style="color:var(--muted)">Da web non si può forzare Storia/Reel: prepariamo i PNG nel formato giusto e poi scegli dall’app.</small>
  </div>
</div>

<script>
  /* ====== CONFIG ====== */
  const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
  const META_GID = '254048258';
  const DIST_GID = '116187224';

  const PUBLISHED_META_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=254048258&single=true';
  const PUBLISHED_DIST_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=116187224&single=true';

  /* numeri e posizioni */
  const XI_NUMBERS   = [1,2,5,3,7,6,4,11,10,9,8];
  const BENCH_NUMBERS= [12,13,14,15,16,17,18,19,20];
  const coords3412 = [
    [50,91], [80,70], [50,73], [20,70],
    [88,48], [62,54], [38,54], [12,48],
    [50,36], [62,16], [38,16]
  ];

  const el = s => document.querySelector(s);

  /* ====== HELPERS URL ====== */
  const gvizJsonURL = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:json`;
  const gvizCsvURL  = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
  function pubCsvURL(pubhtmlUrl){
    const u = new URL(pubhtmlUrl);
    const parts = u.pathname.split('/');
    const idIdx = parts.findIndex(p=>p==='e')+1;
    const id = parts[idIdx] || '';
    const root = `${u.protocol}//${u.host}${parts.slice(0,idIdx).join('/')}/${id}`;
    return `${root}/pub?gid=${encodeURIComponent(u.searchParams.get('gid')||'0')}&single=true&output=csv`;
  }

  /* ====== PARSER ====== */
  function parseCSV(text){
    let t = String(text||'').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
    while (t.startsWith('\n')) t = t.slice(1);
    const lines = t.split('\n').filter((ln,i)=> i===0 || ln.trim().length>0);
    if (!lines.length) return [];
    const rows=[]; let row=[], cur='', inQ=false;
    const pushCell=()=>{ row.push(cur); cur=''; };
    const pushRow =()=>{ rows.push(row); row=[]; };
    const s = lines.join('\n');
    for (let i=0;i<s.length;i++){
      const c=s[i], n=s[i+1];
      if (inQ){
        if (c === '"' && n === '"'){ cur+='"'; i++; }
        else if (c === '"'){ inQ=false; }
        else { cur += c; }
      }else{
        if (c === '"'){ inQ=true; }
        else if (c === ','){ pushCell(); }
        else if (c === '\n'){ pushCell(); pushRow(); }
        else { cur += c; }
      }
    }
    if (cur!=='' || row.length) { pushCell(); pushRow(); }
    if (!rows.length) return [];
    let header = rows.shift();
    while (header && header.every(h=> String(h||'').trim()==='') && rows.length){ header = rows.shift(); }
    if (!header) return [];
    header = header.map(h=>String(h||'').trim());
    return rows
      .filter(r => r.some(v => String(v||'').trim()!==''))
      .map(r => Object.fromEntries(header.map((h,i)=>[h, r[i]!==undefined ? r[i] : '' ])));
  }

  function parseGVizJSON(text){
    const start = text.indexOf('{'); const end = text.lastIndexOf('}');
    if (start<0 || end<0) throw new Error('JSON GViz non trovato');
    const json = JSON.parse(text.slice(start, end+1));
    const cols = json.table.cols.map(c => (c.label || c.id || '').toString().trim() || 'col');
    const rows = json.table.rows.map(r => {
      const obj={};
      r.c.forEach((cell,i)=>{ obj[ cols[i] || ('col'+(i+1)) ] = (cell && cell.v!=null) ? String(cell.v) : ''; });
      return obj;
    });
    return rows;
  }

  /* ====== FETCH con fallback ====== */
  async function fetchRows(metaOrDist){
    const gid = (metaOrDist==='meta') ? META_GID : DIST_GID;
    const pub = (metaOrDist==='meta') ? PUBLISHED_META_URL : PUBLISHED_DIST_URL;

    if (SHEET_FILE_ID && SHEET_FILE_ID !== 'INSERISCI_QUI_FILE_ID'){
      try{
        const res = await fetch(gvizJsonURL(SHEET_FILE_ID, gid), {cache:'no-store'});
        if (!res.ok) throw new Error('GViz JSON '+res.status);
        const txt = await res.text();
        const rows = parseGVizJSON(txt);
        if (rows.length){ return rows; }
      }catch(e){ console.warn('Fallback a GViz CSV:', e.message); }
      try{
        const res = await fetch(gvizCsvURL(SHEET_FILE_ID, gid), {cache:'no-store'});
        if (!res.ok) throw new Error('GViz CSV '+res.status);
        const txt = await res.text();
        const rows = parseCSV(txt);
        if (rows.length){ return rows; }
      }catch(e){ console.warn('Fallback a pub CSV:', e.message); }
    }

    try{
      const res = await fetch(pubCsvURL(pub), {cache:'no-store'});
      if (!res.ok) throw new Error('PUB CSV '+res.status);
      const txt = await res.text();
      const rows = parseCSV(txt);
      if (rows.length){ return rows; }
    }catch(e){ console.warn('Fallback a pubhtml:', e.message); }

    const htmlRes = await fetch(pub, {cache:'no-store'});
    if (!htmlRes.ok) throw new Error('PUBHTML '+htmlRes.status);
    const html = await htmlRes.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const table = doc.querySelector('table');
    if (!table) throw new Error('Tabella non trovata');
    const ths = Array.from(table.querySelectorAll('thead tr th, thead tr td'));
    let header = ths.map(th => th.textContent.trim());
    if (!header.length){
      const firstRowTds = Array.from(table.querySelectorAll('tbody tr:first-child td'));
      header = firstRowTds.map((_,i)=> 'col'+(i+1));
    }
    const out = [];
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr=>{
      const cells = Array.from(tr.children);
      if (!cells.length) return;
      const obj = {};
      cells.forEach((td,i)=>{ obj[ header[i] || ('col'+(i+1)) ] = td.textContent.trim(); });
      if (Object.values(obj).some(v => v && v.trim() !== '')) out.push(obj);
    });
    return out;
  }

  /* ====== NORMALIZE ====== */
  function normalizeMeta(rows){
    const out={};
    if (!rows || !rows.length) return out;
    const headerKeys = Object.keys(rows[0]);
    const norm = k => k.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
    const idxKey = headerKeys.findIndex(k => ['key','chiave','campo','colonna'].includes(norm(k)));
    const idxVal = headerKeys.findIndex(k => ['value','valore','dato','val'].includes(norm(k)));
    rows.forEach(r=>{
      const cols = Object.values(r);
      let raw = '', val = '';
      if (idxKey >= 0 && idxVal >= 0){ raw = String(cols[idxKey]||'').trim(); val = String(cols[idxVal]||'').trim(); }
      else { raw = String(cols[0]||'').trim(); val = String(cols[1]||'').trim(); }
      if (!raw) return;
      const key = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
      out[key] = val;
    });
    return out;
  }
  function normalizeDistinta(rows){
    if (!rows || !rows.length) return new Map();
    const keys = Object.keys(rows[0]);
    const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]/g,'');
    let numKey   = keys.find(k=>['num','numero','n','maglia','shirt','#'].includes(norm(k)));
    let nameKey  = keys.find(k=>['giocatore','nome','cognome','nomecognome','player'].includes(norm(k)));
    let photoKey = keys.find(k=>['foto','photo','immagine','img','picture'].includes(norm(k)));
    const score = Object.fromEntries(keys.map(k=>[k,{num:0,url:0,text:0}]));
    rows.forEach(r=>{
      keys.forEach(k=>{
        const v = String(r[k] ?? '').trim();
        if (!v) return;
        if (/^https?:\/\//i.test(v) || v.includes('/')) score[k].url++;
        if (/^\d{1,2}$/.test(v)) score[k].num++;
        if (/[A-Za-zÀ-ÿ]/.test(v)) score[k].text++;
      });
    });
    if (!numKey)   numKey   = keys.reduce((a,b)=> score[a].num >= score[b].num ? a:b);
    if (!photoKey) photoKey = keys.reduce((a,b)=> score[a].url >= score[b].url ? a:b);
    if (!nameKey){
      const rem = keys.filter(k=>k!==numKey && k!==photoKey);
      nameKey = rem.reduce((a,b)=> (score[a]?.text||0) >= (score[b]?.text||0) ? a:b);
    }
    const map = new Map();
    rows.forEach(r=>{
      const num = Number(String(r[numKey]||'').trim());
      if (!(num>0)) return;
      const name = String(r[nameKey]||'').trim();
      const photo= String(r[photoKey]||'').trim();
      map.set(num, {num, name, photo});
    });
    return map;
  }
  const surname = full => { const t=String(full||'').trim(); if(!t) return ''; const p=t.split(/\s+/); return p[p.length-1]; };

  /* ====== ANTI-OVERLAP ====== */
  function distributeNoOverlap(){
    const pitch = el('#pitch');
    const rect = pitch.getBoundingClientRect();
    const items = Array.from(pitch.querySelectorAll('.player')).map(node=>{
      const xPerc=parseFloat(node.style.left), yPerc=parseFloat(node.style.top);
      const r=node.offsetWidth/2 + 2;
      return {node,xPerc,yPerc,r};
    });
    for(let step=0; step<36; step++){
      let moved=false;
      for(let i=0;i<items.length;i++){
        for(let j=i+1;j<items.length;j++){
          const a=items[i], b=items[j];
          const ax=a.xPerc/100*rect.width, ay=a.yPerc/100*rect.height;
          const bx=b.xPerc/100*rect.width, by=b.yPerc/100*rect.height;
          const dx=bx-ax, dy=by-ay; const dist=Math.hypot(dx,dy);
          const minDist=a.r+b.r+4;
          if(dist<minDist){
            const overlap=minDist-dist || 1;
            const nx=dx/(dist||1), ny=dy/(dist||1);
            const kx=0.25, ky=0.75;
            a.xPerc -= (nx*kx*overlap)/rect.width*100;
            a.yPerc -= (ny*ky*overlap)/rect.height*100;
            b.xPerc += (nx*kx*overlap)/rect.width*100;
            b.yPerc += (ny*ky*overlap)/rect.height*100;
            [a,b].forEach(o=>{
              o.xPerc=Math.min(94,Math.max(6,o.xPerc));
              o.yPerc=Math.min(96,Math.max(4,o.yPerc));
            });
            moved=true;
          }
        }
      }
      if(!moved) break;
    }
    items.forEach(o=>{
      o.node.style.left=o.xPerc+'%';
      o.node.style.top =o.yPerc+'%';
    });
  }

  /* ====== RENDER ====== */
  let CURRENT_META = {};
  function renderAll(meta, byNum){
    CURRENT_META = meta || {};
    const opp = meta['avversario'] || 'AVVERSARIO';
    const when= meta['when'] || meta['data'] || '';
    const logoURL = meta['logourl'] || '';
    el('#clubLogo').src=logoURL||'logo.png';
    el('#matchLine').textContent=`PETRIOLESE vs ${opp}`;
    el('#opponentInline').textContent = opp;
    el('#matchWhen').textContent=when;
    if(meta['pitchurl']) el('#pitchImg').src=meta['pitchurl'];

    const pitch=el('#pitch'); pitch.querySelectorAll('.player').forEach(n=>n.remove());
    XI_NUMBERS.forEach((num,i)=>{
      const p=byNum.get(num)||{num,name:'',photo:''};
      const [x,y]=coords3412[i]||[50,50];

      const node=document.createElement('div'); node.className='player'; node.style.left=x+'%'; node.style.top=y+'%';
      const ball=document.createElement('div'); ball.className='ball';
      if(p.photo){ const img=document.createElement('img'); img.src=p.photo; img.alt=p.name; img.onerror=()=>img.remove(); ball.appendChild(img); }
      node.appendChild(ball);

      const nb=document.createElement('div'); nb.className='num-badge'; nb.textContent=num; node.appendChild(nb);
      const label=document.createElement('div'); label.className='name-below'; label.textContent=surname(p.name)||''; node.appendChild(label);

      pitch.appendChild(node);
    });

    const benchEl=el('#bench'); benchEl.innerHTML='';
    const benchItems=[ ...BENCH_NUMBERS.map(n=>{ const bp=byNum.get(n)||{num:n,name:'',photo:''}; return {code:String(n), name:bp.name, photo:bp.photo}; }),
      {code:'ALL', name:'Castellani', photo:''} ];
    benchItems.forEach(item=>{
      const card=document.createElement('div'); card.className='item';

      const wrap=document.createElement('div'); wrap.className='avatar-wrap';
      const av=document.createElement('div'); av.className='avatar';
      if(item.photo){ const img=document.createElement('img'); img.src=item.photo; img.alt=item.name; img.onerror=()=>img.remove(); av.appendChild(img); }
      const nb=document.createElement('div'); nb.className='num-out'; nb.textContent=item.code; // fuori dal cerchio
      wrap.appendChild(av); wrap.appendChild(nb);
      card.appendChild(wrap);

      const nm=document.createElement('div'); nm.className='name'; nm.textContent=item.name||''; card.appendChild(nm);
      benchEl.appendChild(card);
    });

    el('#notice').textContent='Dati caricati (GViz/CSV/pubhtml)';
    requestAnimationFrame(distributeNoOverlap);
  }

  /* ====== INIT ====== */
  (async function init(){
    try{
      const [metaRows,distRows]=await Promise.all([ fetchRows('meta'), fetchRows('dist') ]);
      const meta=normalizeMeta(metaRows);
      const byNum=normalizeDistinta(distRows);
      renderAll(meta,byNum);
      window.addEventListener('resize', ()=>requestAnimationFrame(distributeNoOverlap));
    }catch(e){
      console.error(e);
      el('#notice').textContent='Errore nel leggere i dati: '+e.message;
      renderAll({}, new Map());
    }
  })();
</script>

<!-- ===== Condivisione ===== -->
<script>
(function(){
  // Modal Instagram
  const igModal = document.getElementById('igModal');
  const openIG  = ()=>igModal.classList.add('open');
  const closeIG = e => { if(!e || e.target===igModal) igModal.classList.remove('open'); };
  igModal.addEventListener('click', closeIG);
  document.getElementById('btnIG')?.addEventListener('click', openIG);

  // Helpers
  async function captureNode(node, scale=2){
    const canvas = await html2canvas(node, {
      backgroundColor: '#0b0f0c',
      scale: scale,
      useCORS: true,
      logging: false
    });
    return canvas;
  }
  function canvasToFile(canvas, name){ return new Promise(r => canvas.toBlob(b => r(new File([b], name, {type:'image/png'})), 'image/png')); }
  function downloadFile(file){
    const url = URL.createObjectURL(file); const a=document.createElement('a');
    a.href=url; a.download=file.name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function loadImage(src){
    return new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=rej; im.src=src; });
  }

  // Disegna titolo (logo + PETRIOLESE CALCIO + VS + AVVERSARIO) in alto sul canvas
  async function drawHeaderOverlay(canvas){
    const ctx = canvas.getContext('2d');
    const W = canvas.width; const pad=40;
    // fascia semi-trasparente
    ctx.fillStyle = 'rgba(0,0,0,.35)';
    ctx.fillRect(0,0,W,120);

    const logoSrc = (document.getElementById('clubLogo')?.getAttribute('src')) || 'logo.png';
    const vsSrc   = 'vs_battle.png';
    const opp     = (document.getElementById('opponentInline')?.textContent||'AVVERSARIO').trim();

    const [logo, vs] = await Promise.all([ loadImage(logoSrc), loadImage(vsSrc) ]);
    const logoH = 70; const logoW = logo.width * (logoH/logo.height);
    const vsH   = 42; const vsW   = vs.width * (vsH/vs.height);

    // misure testi
    ctx.font='900 34px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial';
    const club1 = 'PETRIOLESE'; const club2 = ' CALCIO';
    const club1W = ctx.measureText(club1).width;
    ctx.font='900 34px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial';
    const club2W = ctx.measureText(club2).width;

    ctx.font='900 34px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial';
    const oppW = ctx.measureText(opp).width;

    const gap = 16;
    const totalW = logoW + gap + (club1W+club2W) + gap + vsW + gap + oppW;
    let x = (W - totalW)/2; const yMid = 70;

    // logo
    ctx.drawImage(logo, x, yMid - logoH/2, logoW, logoH); x += logoW + gap;

    // PETRIOLESE (rosso) + CALCIO (blu)
    ctx.textBaseline='middle';
    ctx.font='900 34px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial';
    ctx.fillStyle='#e11d48'; ctx.fillText(club1, x, yMid); x += club1W;
    ctx.fillStyle='#1d4ed8'; ctx.fillText(club2, x, yMid); x += club2W + gap;

    // VS
    ctx.drawImage(vs, x, yMid - vsH/2, vsW, vsH); x += vsW + gap;

    // Avversario
    ctx.fillStyle='#ffffff'; ctx.fillText(opp, x, yMid);
  }

  // Fit in una cornice target (W x H), centrato
  async function fitCanvasTo(canvas, W, H){
    const out = document.createElement('canvas'); out.width=W; out.height=H;
    const ctx=out.getContext('2d'); ctx.fillStyle='#0b0f0c'; ctx.fillRect(0,0,W,H);
    const s = Math.min(W/canvas.width, H/canvas.height);
    const w = canvas.width*s, h = canvas.height*s;
    const x = (W-w)/2, y=(H-h)/2;
    ctx.drawImage(canvas, x, y, w, h);
    return out;
  }

  async function generatePair(){
    const xi = document.getElementById('capture-xi');
    const bench = document.getElementById('capture-bench');
    if(!xi || !bench) throw new Error('Sezioni non trovate');
    let c1 = await captureNode(xi, 2);
    let c2 = await captureNode(bench, 2);
    await drawHeaderOverlay(c1);
    await drawHeaderOverlay(c2);
    return [c1, c2];
  }

  // IG Story (1080x1920)
  document.getElementById('igStoryBtn')?.addEventListener('click', async ()=>{
    try{
      const [c1,c2] = await generatePair();
      const s1 = await fitCanvasTo(c1,1080,1920);
      const s2 = await fitCanvasTo(c2,1080,1920);
      const f1 = await canvasToFile(s1,'petriolese_xi_story.png');
      const f2 = await canvasToFile(s2,'petriolese_panchina_story.png');
      if (navigator.canShare && navigator.canShare({files:[f1,f2]})) {
        await navigator.share({ files:[f1,f2], title:'Petriolese Matchday', text:'Forza Petriolese! 💙❤️' });
      } else {
        downloadFile(f1); downloadFile(f2);
        alert('Condivisione nativa non supportata. Ho scaricato le immagini formato Storia.');
      }
    }catch(e){ console.error(e); alert('Errore durante la generazione immagini Storia.'); }
    igModal.classList.remove('open');
  });

  // IG Feed/Reel (1080x1350)
  document.getElementById('igFeedBtn')?.addEventListener('click', async ()=>{
    try{
      const [c1,c2] = await generatePair();
      const s1 = await fitCanvasTo(c1,1080,1350);
      const s2 = await fitCanvasTo(c2,1080,1350);
      const f1 = await canvasToFile(s1,'petriolese_xi_feed.png');
      const f2 = await canvasToFile(s2,'petriolese_panchina_feed.png');
      if (navigator.canShare && navigator.canShare({files:[f1,f2]})) {
        await navigator.share({ files:[f1,f2], title:'Petriolese Matchday', text:'Forza Petriolese! 💙❤️' });
      } else {
        downloadFile(f1); downloadFile(f2);
        alert('Condivisione nativa non supportata. Ho scaricato le immagini formato Feed.');
      }
    }catch(e){ console.error(e); alert('Errore durante la generazione immagini Feed.'); }
    igModal.classList.remove('open');
  });

  // Facebook (link a live.html)
  document.getElementById('btnFB')?.addEventListener('click', ()=>{
    const liveUrl = new URL('live.html', location.href).href;
    const shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(liveUrl);
    window.open(shareUrl, '_blank', 'noopener,noreferrer,width=700,height=540');
  });

  // Condividi generico: collage (story 1080x1920)
  document.getElementById('btnShare')?.addEventListener('click', async ()=>{
    try{
      const [c1,c2] = await generatePair();
      const W=1080,H=1920,pad=40; const out=document.createElement('canvas'); out.width=W; out.height=H;
      const ctx=out.getContext('2d'); ctx.fillStyle='#0b0f0c'; ctx.fillRect(0,0,W,H);

      const s1 = await fitCanvasTo(c1, W-pad*2, (H-pad*3)/2);
      const s2 = await fitCanvasTo(c2, W-pad*2, (H-pad*3)/2);

      const x = pad;
      const y1 = pad;
      const y2 = y1 + s1.height + pad;

      ctx.drawImage(s1, x, y1);
      ctx.drawImage(s2, x, y2);

      const file = await canvasToFile(out,'petriolese_matchday_story.png');
      if (navigator.canShare && navigator.canShare({files:[file]})) {
        await navigator.share({ files:[file], title:'Petriolese Matchday', text:'Forza Petriolese! 💙❤️' });
      } else {
        downloadFile(file);
        alert('Condivisione nativa non supportata. Ho scaricato il collage (Story).');
      }
    }catch(e){ console.error(e); alert('Errore durante la creazione del collage.'); }
  });
})();
</script>
</body>
</html>
