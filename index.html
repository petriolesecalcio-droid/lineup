<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Petriolese — Matchday</title>
<meta name="theme-color" content="#0b0f0c">
<style>
  :root{
    --club-red:#e11d48; --club-blue:#1d4ed8;
    --bg:#0b0f0c; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --pitch:#0a3d1a; --line:#d1fae5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:1.1rem;margin:0;color:var(--text);font-weight:600}
  .muted{color:var(--muted);font-size:.9rem}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,input[type=file]{background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:8px 12px;font:inherit;cursor:pointer}
  input[type=file]{padding:6px 10px}
  .pitch{
    position:relative;width:100%;aspect-ratio: 105/68; /* proporzioni campo */
    background:radial-gradient(ellipse at center, #0b5d28, var(--pitch));
    border:2px solid var(--line); border-radius:16px; margin-top:12px; overflow:hidden;
  }
  /* linee campo */
  .pitch:before,.pitch:after{
    content:""; position:absolute; left:50%; top:0; bottom:0; width:2px; background:var(--line); opacity:.7; transform:translateX(-50%);
  }
  .box{position:absolute;border:2px solid var(--line); opacity:.8}
  .box.home{left:0;top:20%;height:60%;width:18%}
  .box.away{right:0;top:20%;height:60%;width:18%}
  .arc{position:absolute;border:2px solid var(--line);border-radius:50%}
  .arc.c1{left:-8%;top:35%;width:16%;height:30%;opacity:.6}
  .arc.c2{right:-8%;top:35%;width:16%;height:30%;opacity:.6}
  .player{
    position:absolute; transform:translate(-50%,-50%);
    min-width:56px; max-width:120px; text-align:center;
    background:linear-gradient(180deg,var(--club-red),#8b112e);
    color:white; padding:6px 8px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.35);
    border:2px solid rgba(255,255,255,.15);
    font-weight:600; font-size:.95rem;
  }
  .player .num{display:block;font-size:.8rem;opacity:.9}
  .bench{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:12px}
  .bench .slot{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:8px}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .small{font-size:.85rem}
  .ok{color:#10b981}
  .err{color:#ef4444}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="title">Petriolese — Matchday</h1>
        <div class="muted" id="subtitle">Modulo: <span id="modulo">-</span></div>
      </div>
      <div class="bar">
        <button id="reloadBtn" title="Ricarica formazione.json">Ricarica JSON</button>
        <input type="file" id="fileInput" accept=".json" />
        <span class="small muted" id="status">pronto</span>
      </div>
    </header>

    <div class="pitch" id="pitch">
      <div class="box home"></div>
      <div class="box away"></div>
      <div class="arc c1"></div>
      <div class="arc c2"></div>
    </div>

    <h2 style="margin:14px 0 8px;font-size:1rem">Panchina</h2>
    <div class="bench" id="bench"></div>
  </div>

<script>
/* --- Preset coordinate per moduli comuni (percentuali x,y) --- */
const PRESETS = {
  "3-4-1-2": [
    {x:10, y:50, pos:"POR"},            // Portiere
    {x:27, y:25, pos:"BRACCETTO D"},    // Linea 3
    {x:23, y:50, pos:"CENTRALE"},
    {x:27, y:75, pos:"BRACCETTO S"},
    {x:40, y:20, pos:"ESTERNO D"},      // Linea 4
    {x:40, y:45, pos:"MEZZALA D"},
    {x:40, y:55, pos:"MEDIANO"},
    {x:40, y:80, pos:"ESTERNO S"},
    {x:58, y:50, pos:"TREQUARTISTA"},   // 1
    {x:75, y:38, pos:"ATT"},            // 2 punte
    {x:75, y:62, pos:"ATT"},
  ],
  "4-3-3": [
    {x:10,y:50,pos:"POR"},
    {x:25,y:20,pos:"TD"},{x:25,y:40,pos:"DC"},{x:25,y:60,pos:"DC"},{x:25,y:80,pos:"TS"},
    {x:45,y:30,pos:"MED"},{x:45,y:50,pos:"REG"},{x:45,y:70,pos:"MED"},
    {x:70,y:25,pos:"ALA"},{x:76,y:50,pos:"PC"},{x:70,y:75,pos:"ALA"},
  ]
};

/* elementi UI */
const pitch = document.getElementById('pitch');
const bench = document.getElementById('bench');
const statusEl = document.getElementById('status');
const moduloEl = document.getElementById('modulo');
const titleEl = document.getElementById('title');

function setStatus(msg, ok=true){
  statusEl.textContent = msg;
  statusEl.className = 'small ' + (ok ? 'ok' : 'err');
}

/* render giocatori in campo */
function renderField(data){
  pitch.querySelectorAll('.player').forEach(el => el.remove());

  const modulo = (data.modulo || '3-4-1-2').trim();
  moduloEl.textContent = modulo;
  if (data.titolo) titleEl.textContent = data.titolo;

  const preset = PRESETS[modulo] || PRESETS["3-4-1-2"];
  const players = (data.titolari || []).slice(0, preset.length);

  players.forEach((p, i) => {
    const spot = preset[i] || preset[preset.length-1];
    const el = document.createElement('div');
    el.className = 'player';
    el.style.left = spot.x + '%';
    el.style.top = spot.y + '%';
    el.innerHTML = `${p.nome || '—'} <span class="num">#${p.num ?? ''} · ${p.pos || spot.pos || ''}</span>`;
    pitch.appendChild(el);
  });
}

/* render panchina */
function renderBench(data){
  bench.innerHTML = '';
  (data.panchina || []).forEach(p => {
    const card = document.createElement('div');
    card.className = 'slot';
    card.innerHTML = `
      <div class="row">
        <strong>${p.nome || '—'}</strong>
        <span class="small muted">#${p.num ?? ''}</span>
      </div>
      <div class="small muted">${p.ruolo || ''}</div>
    `;
    bench.appendChild(card);
  });
}

function applyTheme(data){
  if (data.colori?.maglia){
    document.documentElement.style.setProperty('--club-red', data.colori.maglia);
  }
  if (data.colori?.seconda){
    document.documentElement.style.setProperty('--club-blue', data.colori.seconda);
  }
}

/* carica json da URL (stessa cartella) */
async function loadFromUrl(url='formazione.json'){
  try{
    setStatus('carico…');
    const res = await fetch(url + '?v=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    applyTheme(data); renderField(data); renderBench(data);
    setStatus('ok');
  }catch(e){
    console.warn(e);
    setStatus('impossibile leggere formazione.json (usa “Carica JSON”)', false);
  }
}

/* carica json da file input */
function loadFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      applyTheme(data); renderField(data); renderBench(data);
      setStatus('ok (da file)');
    }catch(e){
      setStatus('JSON non valido', false);
    }
  };
  reader.readAsText(file);
}

document.getElementById('reloadBtn').onclick = ()=> loadFromUrl();
document.getElementById('fileInput').onchange = (e)=>{
  const f = e.target.files?.[0];
  if (f) loadFromFile(f);
};

/* avvio: prova a leggere formazione.json nella stessa cartella */
loadFromUrl();
</script>
</body>
</html>
