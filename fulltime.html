<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Full Time ‚Äì Petriolese Calcio</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --bg:#0b0c11; --roof-dark:#151923; --roof-mid:#1f2531; --roof-glow:rgba(255,255,255,.08);
    --vs-gap:1.4cqw;
    /* titolo/macchia pi√π grandi */
    --md-w: 86cqw;
    --md-splat-bleed: 3.2cqh;
    --fab-stack-gap: clamp(8px,1.6cqw,12px);
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);display:grid;place-items:center;font-family:system-ui,Arial,sans-serif}

  .stage{
    position:relative; width:min(1200px,96vw); aspect-ratio:9/16; max-height:96vh;
    overflow:hidden; border-radius:18px; background:#0b0c11; box-shadow:0 25px 80px rgba(0,0,0,.6);
    container-type:size;
  }

  /* video bg */
  #bg-video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0;
             filter:brightness(.32) contrast(1.05) saturate(1.05); background:#0b0c11; }

  /* overlay */
  .stadium{ position:absolute; inset:0; z-index:1; pointer-events:none;
            background: radial-gradient(1200px 260px at 50% -40px, var(--roof-glow), transparent 60%),
                        linear-gradient(to bottom, rgba(31,37,49,.66), rgba(21,25,35,.78) 48%, rgba(6,16,7,.92)); }
  .roof-stripes{ position:absolute; inset:0; z-index:2; pointer-events:none; display:block; }

  .wrap{ position:absolute; inset:0; z-index:4; display:grid; grid-template-rows:auto 1fr auto; align-items:center; justify-items:center; padding:4cqh 3cqw; }

  /* titolo + macchia ingranditi */
  .title-badge{ position:relative; width:var(--md-w); aspect-ratio:5.3/1; display:grid; place-items:center; overflow:visible; pointer-events:none; }
  .title-badge::before{ content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
                        width:100%; height:calc(100% + var(--md-splat-bleed)*2);
                        background:url('md-splat.webp') center/contain no-repeat;
                        filter:drop-shadow(0 18px 44px rgba(0,0,0,.38)); z-index:-1; }
  .title{ color:#fff; font-weight:900; text-transform:uppercase; letter-spacing:.26cqw; font-size:clamp(22px,6cqw,48px); text-align:center; }

  .vs-block{ margin-top:2.0cqh; width:100%; display:grid; gap:1.0cqh; }

  /* DRAWER (marcatori) sopra/sotto */
  .wing-row{
    width:100%; display:grid;
  }
  .wing{
    background:rgba(255,255,255,.08); border-radius:14px;
    box-shadow:0 0 0 1px rgba(255,255,255,.06) inset;
    color:#e6ebf2; font-weight:600; font-size:clamp(12px,2.1cqw,16px);
    line-height:1.5; padding:.8cqh 1.1cqw;
    display:grid; grid-auto-rows:min-content; gap:.6cqh; min-height:3.2cqh;
    justify-items:start; text-align:left;
    max-width:min(44cqw, 520px);
  }
  #wingTop { justify-items:start; }
  #wingTop .wing { justify-self:start; }   /* a sinistra */
  #wingBottom { justify-items:end; }
  #wingBottom .wing { justify-self:end; justify-items:end; text-align:right; }  /* a destra  */
  .scorer{ display:inline-flex; align-items:center; gap:.35cqw; white-space:nowrap; }
  .scorer .ball{ transform:translateY(.02em); }

  /* BLOCCO CENTRALE: team1 (sopra) -> score -> team2 (sotto) */
  .score-stack{
    display:grid; align-items:center; justify-items:center;
    grid-template-rows:auto auto auto; gap:1.2cqh;
    width:100%;
  }

  .team{ display:flex; align-items:center; gap:var(--vs-gap); color:#fff; font-weight:900; text-transform:uppercase; letter-spacing:.18cqw; font-size:clamp(18px,2.8cqw,28px); }
  .team .team-logo{ height:8.6cqh; width:auto; object-fit:contain; display:block; }
  .team-left{ justify-self:start; margin-left:6cqw; }
  .team-right{ justify-self:end; margin-right:6cqw; }
  .team.win{ filter: drop-shadow(0 6px 16px rgba(0,0,0,.35)); }
  .team-right span{ order:1 }  /* nome prima del logo a destra */
  .team-right img{ order:2 }

  .score-center{ display:flex; align-items:center; gap:clamp(10px,2.2cqw,18px); color:#fff; }
  .score-num{ font-weight:900; letter-spacing:.18cqw; line-height:1; font-size:clamp(46px,11cqw,104px); filter:drop-shadow(0 8px 18px rgba(0,0,0,.35)); }
  .dash{ font-weight:900; font-size:clamp(26px,5.6cqw,52px); opacity:.9; }

  .meta{ margin-top:1.0cqh; color:#cfd3dc; text-align:center; opacity:.95; font-size:clamp(13px,2.2cqw,16px); letter-spacing:.06cqw; }

  .venue{ margin-top:1.0cqh; display:inline-flex; align-items:center; gap:.6cqw; padding:.7cqh 1.2cqw; border-radius:999px;
          background:rgba(255,255,255,.08); box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; white-space:nowrap; max-width:92cqw; overflow:hidden; }
  .venue .pin{ filter:drop-shadow(0 1px 0 rgba(0,0,0,.25)); flex:0 0 auto; }
  .venue a{ color:#e6ebf2; text-decoration:none; font-weight:700; letter-spacing:.04cqw; font-size:clamp(13px,2.2cqw,16px); display:inline-block; overflow:hidden; text-overflow:ellipsis; max-width:calc(92cqw - 4cqw); }
  .venue a:hover{ text-decoration:underline; }

  /* FABs */
  .fab{
    --fab-size: clamp(36px, 10cqw, 48px);
    --fab-edge: clamp(10px, 2cqw, 16px);
    --fab-radius: 12px;
    position:absolute; top:var(--fab-edge); left:var(--fab-edge);
    width:var(--fab-size); height:var(--fab-size); display:grid; place-items:center;
    border:1px solid rgba(0,0,0,.08); border-radius:var(--fab-radius);
    background:#fff; color:#111;
    box-shadow:0 2px 4px rgba(0,0,0,.18), 0 8px 16px rgba(0,0,0,.16);
    cursor:pointer; z-index:10;
    transition:transform .15s ease, box-shadow .15s ease, background-color .15s ease, opacity .15s ease, border-color .15s ease;
  }
  .fab:hover{ transform:translateY(-1px); background:#f5f6f8; box-shadow:0 3px 6px rgba(0,0,0,.20), 0 12px 20px rgba(0,0,0,.18); }
  .fab:active{ transform:translateY(0); background:#eceef2; }
  .fab:focus-visible{ outline:3px solid rgba(66,133,244,.55); outline-offset:2px; }
  .fab[aria-busy="true"]{ pointer-events:none; opacity:.7 }
  .fab svg{ width:calc(var(--fab-size)*.56); height:calc(var(--fab-size)*.56); }

  .fab-ig{ top: calc(var(--fab-edge) + var(--fab-size) + var(--fab-stack-gap)); }
  .fab-wa{ top: calc(var(--fab-edge) + (var(--fab-size) + var(--fab-stack-gap)) * 2); }

@container (max-width: 520px){
  /* FAB scaling (gi√† presente) */
  .fab{ --fab-size: clamp(24px, 7cqw, 34px); --fab-edge: clamp(8px, 1.6cqw, 12px); --fab-radius: 10px; }
  .fab svg{ width: calc(var(--fab-size) * .50); height: calc(var(--fab-size) * .50); }

  /* üîΩ Marcatori impilati su mobile */
  /* i drawer diventano colonne: un marcatore per riga */
  .wing{
    display: grid;                /* da flex -> grid per stack verticale */
    grid-auto-rows: min-content;
    gap: .6cqh;                   /* spazio verticale tra marcatori */
    max-width: calc(100% - 12cqw);/* lascia respiro ai bordi */
    padding-block: .9cqh;
  }
  .wing .scorer{
    display: flex;
    align-items: center;
    gap: .6cqw;
    white-space: normal;          /* consenti a nomi lunghi di andare a capo */
  }

  /* allineamenti rispetto ai team */
  /* drawer sopra = marcatori squadra1 -> allineati al logo S1 */
  #wingTop .wing{
    justify-self: start;
    margin-left: 6cqw;            /* stessa indentazione del blocco team-left */
    text-align: left;
  }
  /* drawer sotto = marcatori squadra2 -> allineati al blocco team-right */
  #wingBottom .wing{
    justify-self: end;
    margin-right: 6cqw;           /* stessa indentazione del blocco team-right */
    text-align: right;
  }
}
</style>
</head>
<body>
  <div class="stage">
    <video id="bg-video" autoplay muted loop playsinline preload="metadata">
      <source src="video_2025-09-02_23-14-49.mp4" type="video/mp4">
    </video>

    <div class="stadium"></div>
    <svg class="roof-stripes" viewBox="0 0 1000 1778" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <pattern id="diag" patternUnits="userSpaceOnUse" width="44" height="44" patternTransform="rotate(-10)">
          <rect x="0" y="0" width="44" height="14" fill="#ffffff" opacity="0.06"/>
          <rect x="0" y="14" width="44" height="30" fill="transparent"/>
        </pattern>
      </defs>
      <rect x="0" y="0" width="1000" height="1778" fill="url(#diag)"/>
    </svg>

    <div class="wrap">
      <div class="title-badge"><div class="title">Full Time</div></div>

      <div class="vs-block">

        <!-- drawer sopra (S1 a sinistra) -->
        <div class="wing-row" id="wingTop">
          <div class="wing" id="wing1" hidden></div>
        </div>

        <!-- blocco centrale: team1 / score / team2 -->
        <div class="score-stack">
          <div class="team team-left">
            <img id="logo1" class="team-logo" alt="" />
            <span id="t1">‚Äî</span>
          </div>

          <div class="score-center">
            <span class="score-num" id="s1">0</span>
            <span class="dash">‚Äì</span>
            <span class="score-num" id="s2">0</span>
          </div>

          <div class="team team-right">
            <span id="t2">‚Äî</span>
            <img id="logo2" class="team-logo" alt="" />
          </div>
        </div>

        <!-- drawer sotto (S2 a destra) -->
        <div class="wing-row" id="wingBottom">
          <div class="wing" id="wing2" hidden></div>
        </div>

      </div>

      <div class="meta" id="metaLine">‚Äî</div>

      <div class="venue" id="venueBox" hidden>
        <span class="pin" aria-hidden="true">üìç</span>
        <a id="venueLink" target="_blank" rel="noopener">Campo</a>
      </div>
    </div>

    <!-- FABs -->
    <button id="shareFab" class="fab fab-share" title="Condividi" aria-label="Condividi">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.2 3.2 0 000-1.39l7-4.11a2.5 2.5 0 10-.9-1.45l-7 4.11a2.5 2.5 0 100 4.07l7.05 4.14a2.5 2.5 0 101.94-2z"/>
      </svg>
    </button>
    <button id="igFab" class="fab fab-ig" title="Apri Instagram @asd_petriolese_calcio" aria-label="Apri Instagram @asd_petriolese_calcio">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="18" height="18" rx="5" ry="5"></rect>
        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
        <circle cx="17.5" cy="6.5" r="1.2"></circle>
      </svg>
    </button>
    <button id="waFab" class="fab fab-wa" title="Apri canale WhatsApp" aria-label="Apri canale WhatsApp">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M20.5 11.9c0 4.73-3.86 8.56-8.62 8.56a8.6 8.6 0 0 1-4.46-1.26L3.5 20.5l1.37-3.8a8.52 8.52 0 0 1-1.0-3.8C3.87 8.18 7.73 4.35 12.49 4.35c4.76 0 8.02 3.83 8.02 7.55Z"/>
        <path d="M9.3 8.9c-.24.12-.8.59-.8 1.39 0 .8.5 1.58.57 1.68.09.12 1.57 2.52 4.02 3.48 2.46.96 2.46.64 2.91.62.45-.02 1.44-.59 1.64-1.16.2-.57.2-1.07.14-1.18-.06-.11-.22-.17-.47-.3-.25-.12-1.44-.71-1.66-.79-.22-.08-.38-.12-.54.12-.16.24-.63.79-.77.95-.14.16-.28.18-.53.06-.25-.12-1.05-.39-2.0-1.24-.74-.64-1.23-1.43-1.38-1.67-.14-.24-.01-.37.11-.49.11-.11.25-.3.37-.45.12-.16.16-.24.24-.41.08-.16.04-.3-.02-.42-.06-.12-.54-1.3-.74-1.77-.2-.46-.4-.39-.54-.39-.14 0-.3 0-.54.12Z"/>
      </svg>
    </button>
  </div>

<script src="js/sheet-utils.js"></script>
<script>
/* ====== SHEET CONFIG ====== */
const SHEET_FILE_ID='1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const META_GID='254048258';
const OPP_GID='1284472120';
const PUBLISHED_META_URL='';
const PUBLISHED_OPP_URL='';

const Sheets = window.PetrioleseSheets;
if(!Sheets){
  throw new Error('PetrioleseSheets utils not loaded');
}
const { fetchCsvPrefer, normalizeMeta, normalizeOpp, resolveLogoSrc, setLogo } = Sheets;

function formatWhen(dt){ try{ return dt.toLocaleString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}); }catch{ return dt.toString(); } }

/* Venue & Maps */
function parseCoords(s){ if(!s) return null; const m=String(s).trim().match(/(-?\d+(?:[.,]\d+)?)\s*[,;\s]\s*(-?\d+(?:[.,]\d+)?)/); if(!m) return null; const lat=parseFloat(m[1].replace(',','.')); const lon=parseFloat(m[2].replace(',','.')); return (isFinite(lat)&&isFinite(lon))?{lat,lon}:null; }
function isGoodMapsLink(url){ try{ const u=new URL(url),h=u.hostname.toLowerCase(),p=u.pathname.toLowerCase(); if(h==='maps.app.goo.gl') return true; if(h.endsWith('.google.com')&&p.startsWith('/maps')) return true; if(h==='goo.gl'&&p.startsWith('/maps')) return true; return false; }catch{ return false; } }
function normalizeVenues(rows){ const out=new Map(); rows.forEach(r=>{ const name=String(r.Squadra||r.squadra||'').trim(); const campo=String(r.Campo||r.campo||r.Venue||r.venue||r.Stadio||'').trim(); const coord=String(r.Coordinate||r.coordinate||r.Coords||r.coords||r.GPS||'').trim(); const link=String(r.Link||r.link||r.Maps||r.maps||r.URL||r.url||'').trim(); if(!name) return; const coords=parseCoords(coord); out.set(name.toLowerCase(),{venue:campo||'', lat:coords?.lat??null, lon:coords?.lon??null, link:isGoodMapsLink(link)?link:''}); }); return out; }
function buildMapsLink({venue,lat,lon,link}){ if(link) return link; if(venue) return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue)}`; if(lat!=null&&lon!=null) return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`; return '#'; }

/* Marcatori */
function splitScorers(meta, k1=['marcatori1','scorer1','marcatori_casa'], k2=['marcatori2','scorer2','marcatori_ospiti']){
  const pick=(keys)=>{ for(const k of keys){ const v=(meta.get(k)||'').toString().trim(); if(v) return v; } return ''; };
  const s1=pick(k1), s2=pick(k2);
  const split=s=> s? s.split(/[;,|]\s*|\s{2,}/).map(x=>x.trim()).filter(Boolean) : [];
  return {list1:split(s1), list2:split(s2)};
}
function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function renderWing(list){ if(!list.length) return ''; return list.map(n=>`<span class="scorer"><span class="ball" aria-hidden="true">‚öΩ</span>${esc(n)}</span>`).join(''); }

/* Score */
function readScore(meta){
  const raw=(meta.get('finale')||meta.get('risultato')||meta.get('ft')||meta.get('score')||'').toString().trim();
  const m=raw.match(/(\d+)\s*[-:‚Äì]\s*(\d+)/);
  if(m) return {s1:+m[1], s2:+m[2]};
  const a1=(meta.get('gol1')||meta.get('score1')||'').toString().trim();
  const a2=(meta.get('gol2')||meta.get('score2')||'').toString().trim();
  if(a1!==''&&a2!=='') return {s1:+a1, s2:+a2};
  return {s1:null,s2:null};
}

/* ====== INIT ====== */
(async function init(){
  // sheet
  const [metaRows, oppRows] = await Promise.all([
    fetchCsvPrefer(SHEET_FILE_ID, META_GID, PUBLISHED_META_URL),
    fetchCsvPrefer(SHEET_FILE_ID, OPP_GID,  PUBLISHED_OPP_URL)
  ]);
  const meta=normalizeMeta(metaRows);
  const opp=normalizeOpp(oppRows);
  const venuesM=normalizeVenues(oppRows);

  const squadra1=(meta.get('squadra1')||'Petriolese').toString().trim()||'Petriolese';
  const squadra2=(meta.get('squadra2')||'').toString().trim();
  const dateStr =(meta.get('data')||meta.get('prossimadata')||meta.get('prossima_data')||'').toString().trim();
  const timeStr =(meta.get('ora') ||meta.get('prossimaora') ||meta.get('prossima_ora') ||'').toString().trim();

  // venue
  let venueMeta=(meta.get('luogo')||meta.get('campo')||meta.get('stadio')||meta.get('venue')||'').toString().trim();
  let venue=''; let lat=null, lon=null; let link='';
  const vRec=venuesM.get((squadra1||'').toLowerCase());
  if(vRec){ venue=vRec.venue||''; lat=vRec.lat; lon=vRec.lon; link=vRec.link||''; }
  if(!venue) venue=venueMeta;

  // nomi/loghi
  document.getElementById('t1').textContent=squadra1||'‚Äî';
  document.getElementById('t2').textContent=squadra2||'‚Äî';
  setLogo(document.getElementById('logo1'), resolveLogoSrc(squadra1,opp), squadra1);
  setLogo(document.getElementById('logo2'), resolveLogoSrc(squadra2,opp), squadra2);

  // risultato
  const {s1,s2}=readScore(meta);
  const s1El=document.getElementById('s1');
  const s2El=document.getElementById('s2');
  if(s1!=null && s2!=null){
    s1El.textContent=s1; s2El.textContent=s2;
    if(s1>s2) document.querySelector('.team-left').classList.add('win');
    else if(s2>s1) document.querySelector('.team-right').classList.add('win');
  }else{ s1El.textContent='‚Äî'; s2El.textContent='‚Äî'; }

  // marcatori ‚Üí drawer sopra/sotto
  const {list1,list2}=splitScorers(meta);
  if(list1.length){ wing1.innerHTML=renderWing(list1); wing1.hidden=false; }
  if(list2.length){ wing2.innerHTML=renderWing(list2); wing2.hidden=false; }

  // data/ora
  const dt=(function(dateStr,timeStr){
    const s=String(dateStr||'').trim(), t=String(timeStr||'').trim();
    if(!s) return null;
    const c = s.includes(':') ? s : (t ? `${s} ${t}` : s);
    const m1=c.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:[ T](\d{1,2}):(\d{2}))?$/);
    const m2=c.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2}))?$/);
    let y,M,d,h=15,min=0;
    if(m1){ d=+m1[1]; M=+m1[2]-1; y=+m1[3]; if(m1[4]){h=+m1[4]; min=+m1[5];} }
    else if(m2){ y=+m2[1]; M=+m2[2]-1; d=+m2[3]; if(m2[4]){h=+m2[4]; min=+m2[5];} }
    else return new Date(s);
    return new Date(y,M,d,h,min,0,0);
  })(dateStr,timeStr);

  const metaLine=document.getElementById('metaLine');
  if(dt && !isNaN(+dt)) metaLine.textContent=formatWhen(dt); else metaLine.textContent='';

  // venue pill
  if(venue){
    const box=document.getElementById('venueBox');
    const a=document.getElementById('venueLink');
    a.textContent=venue; a.href=buildMapsLink({venue,lat,lon,link}); a.title=venue; box.hidden=false;
  }
})();
</script>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<script type="module">
import { createStageShareHandler, createInstagramOpener, createWhatsAppOpener } from './js/share-controls.js';

function setupFullTimeShare(){
  const stage = document.querySelector('.stage');
  const shareFab = document.getElementById('shareFab');
  const igFab = document.getElementById('igFab');
  const waFab = document.getElementById('waFab');

  if(igFab){
    const openInstagram = createInstagramOpener({ username: 'asd_petriolese_calcio' });
    igFab.addEventListener('click', openInstagram, { passive: true });
  }

  if(waFab){
    const openWhatsApp = createWhatsAppOpener({ url: 'https://whatsapp.com/channel/0029Vb6QY82I7BeLPf1qXZ2E' });
    waFab.addEventListener('click', openWhatsApp, { passive: true });
  }

  if(!stage || !shareFab) return;

  const shareHandler = createStageShareHandler(stage, {
    hideDuringCapture: [shareFab, igFab, waFab],
    shareTitle: 'Full Time ‚Äì Petriolese',
    fileNamePrefix: 'fulltime_petriolese',
    backgroundColor: '#0b0c11'
  });

  shareFab.addEventListener('click', async () => {
    try{
      shareFab.setAttribute('aria-busy', 'true');
      await shareHandler();
    }catch(error){
      console.error(error);
      alert('Condivisione non disponibile.');
    }finally{
      shareFab.removeAttribute('aria-busy');
    }
  }, { passive: true });
}

if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', setupFullTimeShare, { once: true });
}else{
  setupFullTimeShare();
}
</script>
</body>
</html>
