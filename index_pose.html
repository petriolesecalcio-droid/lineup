<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matchday - Petriolese Calcio</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --pitch-bottom: 14%;           /* distanza del trapezio dal fondo */
    --subs-gap:      8%;           /* spazio tra campo e zona subs */
    --bg:#0b0c11;
    --roof-dark:#151923;
    --roof-mid:#1f2531;
    --roof-glow:rgba(255,255,255,.08);
    --grass-1:#0a6f20; --grass-2:#0d7f26;
    --rossoblu:linear-gradient(90deg,#8b0000,#000080);

    /* === Manopole giocatori / badge (in cqh = % altezza campo) === */
    --photo-h: 20cqh;              /* altezza foto titolari */
    --badge-w: 16cqh;              /* larghezza badge giocatore */
    --badge-font: min(1.8cqh, 2.3cqw);
    --badge-overlap: 1.4cqh;

    /* === Manopole SUBS (testo elenco) === */
    --subs-font:  min(1.6cqh, 2.1cqw);
    --subs-weight: 800;
    --subs-tracking: .18cqw;
    --subs-line: 1.15;
    --subs-transform: uppercase;
    --subs-maxw: calc(100% - 6cqw);
    --subs-font-family: system-ui, Arial, sans-serif;
    --subs-drop: 1cqh;   /* quanto scende SUBS sotto la linea di fondo */

    /* === Pennellata: quanto deve “sbordare” verticalmente === */
    --brush-bleed-y: .9cqh;
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:grid; place-items:center;
    font-family:system-ui,Arial,sans-serif;
  }

  .stage{
    position:relative;
    width:min(1200px,96vw);
    aspect-ratio:9/16;
    max-height:96vh;
    overflow:hidden;
    border-radius:18px;
    background:#0b0c11;
    box-shadow:0 25px 80px rgba(0,0,0,.6);
    container-type:size;           /* abilita cqw + cqh */
  }

  .stadium{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 220px at 50% -40px, var(--roof-glow), transparent 60%),
      repeating-linear-gradient(-10deg, rgba(255,255,255,.05) 0 14px, rgba(0,0,0,0) 14px 44px),
      linear-gradient(to bottom, var(--roof-mid) 0%, var(--roof-dark) 48%, #061007 100%);
  }

  /* Campo in clip */
  .pitch-wrap{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    clip-path: polygon(12% 12%, 88% 12%, 100% 100%, 0 100%);
  }
  .grass{
    position:absolute; inset:0;
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.08) 0 6%, rgba(0,0,0,0) 6% 12%),
      linear-gradient(to bottom, var(--grass-2), var(--grass-1));
    box-shadow: inset 0 -40px 80px rgba(0,0,0,.35);
  }
  svg{position:absolute; inset:0; width:100%; height:100%;}

  /* Layer giocatori (stessa cornice del campo, NO clip) */
  .players{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    overflow:visible; pointer-events:none;
    container-type:size;
  }

  .player{
    position:absolute;
    left:0; top:0;
    transform:translate(-50%, -100%);
    display:block;
    overflow:visible;
  }

  .player .photo{
    height: var(--photo-h);
    width: auto;
    position: relative;
    display: block;
    z-index: 1;
  }

  /* badge sovrapposto: non aumenta l’ingombro verticale */
  .badge{
    position: absolute;
    left: 50%;
    top: calc(100% - var(--badge-overlap));
    transform: translateX(-50%);
    display: flex; align-items: center; justify-content: center;
    width: var(--badge-w);
    aspect-ratio: 5.5/1;
    font-size: var(--badge-font);
    font-weight: 900;
    background: url('badge.png?v=6') center/100% auto no-repeat; /* badge dei giocatori (resta invariato) */
    color:#000; white-space: nowrap; line-height: 1;
    pointer-events: none;
    z-index: 2;
  }

  /* ====== BADGE GLOBALI CON PENNELLATA WEBP ====== */

  /* MATCHDAY in alto a sinistra (lasciato com'è) */
  .matchday-badge{
    position:absolute;
    top:2cqh; left:2cqw;
    width: 26cqw;                /* scala con la larghezza del container */
    aspect-ratio: 5.5/1;
    display:flex; align-items:center; justify-content:center;
    background: url('badge-bg.webp') center / cover no-repeat; /* pennellata rossa/blu */
    color:#fff; font-weight:900;
    font-size: min(1.8cqh, 2.3cqw);
    letter-spacing:.2cqw;
    text-transform: uppercase;
    padding: 0 .8cqw;            /* un filo di respiro laterale */
    filter: drop-shadow(0 2px 10px rgba(0,0,0,.35));
  }

  /* SUBS a cavallo della linea di fondo: pennellata nello ::before con "bleed" */
  .subs-badge{
    position:absolute;
    bottom: var(--pitch-bottom);
    /* left: (impostato via JS) */
    transform: translate(-50%, calc(50% + var(--subs-drop)));
    width: 30cqw;                
    aspect-ratio: 5.5/1;
    display:flex; align-items:center; justify-content:center;

    /* niente background qui: così il ::before può sbordare senza essere tagliato */
    background: none;
    overflow: visible;

    color:#fff; font-weight:900;
    font-size: min(1.6cqh, 2.1cqw);
    letter-spacing:.18cqw;
    text-transform: uppercase;
    padding: 0 .8cqw;
    filter: drop-shadow(0 2px 10px rgba(0,0,0,.35));
    pointer-events:none;
    z-index: 3;
  }
  .subs-badge::before{
    content:"";
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    width: 100%;
    height: calc(100% + var(--brush-bleed-y) * 2); /* più alta: niente “taglio piatto” */
    background: url('badge-bg.webp') center / contain no-repeat;
    z-index:-1; pointer-events:none;
  }

  /* Zona sotto al campo = tutto lo spazio dal fondo campo al fondo stage */
  .subs-zone{
    position:absolute;
    left:0; right:0; bottom:0;
    height: var(--pitch-bottom);
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 0 2cqw;
    pointer-events:none;
  }

  .subs-zone .subs-list{
    position: static;
    margin: 0 auto;
    max-width: var(--subs-maxw);
    text-align:center;
    white-space: normal;
    overflow-wrap:anywhere;
    font-family: var(--subs-font-family);
    font-size: var(--subs-font);
    font-weight: var(--subs-weight);
    letter-spacing: var(--subs-tracking);
    line-height: var(--subs-line);
    text-transform: var(--subs-transform);
    color:#fff; opacity:.95;
  }
</style>
</head>
<body>
  <div class="stage">
    <div class="stadium"></div>

    <!-- MATCHDAY (pennellata) -->
    <div class="matchday-badge">MATCHDAY</div>

    <!-- Campo (clip) -->
    <div class="pitch-wrap">
      <div class="grass"></div>
      <svg viewBox="0 0 1000 1000" preserveAspectRatio="none">
        <g id="lines" stroke="white" fill="none"></g>
      </svg>
    </div>

    <!-- Layer giocatori (NO clip) -->
    <div class="players" id="players"></div>

    <!-- SUBS (pennellata con bleed) -->
    <div id="subsBadge" class="subs-badge">SUBS</div>

    <!-- Elenco panchina -->
    <div class="subs-zone">
      <div class="subs-list" id="subsList"></div>
    </div>
  </div>

<script>
/* ====== DISEGNO CAMPO ====== */
const W=68,H=105,areaW=40.32,areaD=16.5,goalW=18.32,goalD=5.5,spot=11,R=9.15;
const TL={x:120,y:130}, TR={x:880,y:130}, BL={x:0,y:1000}, BR={x:1000,y:1000};
const lerp=(a,b,t)=>({x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t});
function map(u,v){const t=v/H, L=lerp(TL,BL,t), Rr=lerp(TR,BR,t), s=u/W; return {x:L.x+(Rr.x-L.x)*s, y:L.y+(Rr.y-L.y)*s};}
const G=document.getElementById('lines');
function addPolyline(pts,w=3){const el=document.createElementNS('http://www.w3.org/2000/svg','polyline'); el.setAttribute('points',pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ')); el.setAttribute('stroke','white'); el.setAttribute('fill','none'); el.setAttribute('stroke-width',w); el.setAttribute('stroke-linecap','round'); el.setAttribute('stroke-linejoin','round'); G.appendChild(el);}
const addLine=(u1,v1,u2,v2,w=3)=>addPolyline([map(u1,v1),map(u2,v2)],w);
function addRect(x1,y1,x2,y2,w=3){addLine(x1,y1,x2,y1,w); addLine(x1,y2,x2,y2,w); addLine(x1,y1,x1,y2,w); addLine(x2,y1,x2,y2,w);}
function addCircle(cx,cy,r,from,to,steps=240,w=3){const pts=[]; for(let i=0;i<=steps;i++){const a=from+(to-from)*i/steps; pts.push(map(cx+r*Math.cos(a),cy+r*Math.sin(a)));} addPolyline(pts,w);}
function addDot(u,v,r=2.2){const p=map(u,v); const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',r); c.setAttribute('fill','white'); G.appendChild(c);}
addPolyline([TL,TR,BR,BL,TL],6);
addLine(0,H/2,W,H/2,3);
addCircle(W/2,H/2,R,0,2*Math.PI,280,3); addDot(W/2,H/2);
const cx=W/2, ax1=cx-areaW/2, ax2=cx+areaW/2, ay2=areaD;
const gx1=cx-goalW/2, gx2=cx+goalW/2, gy2=goalD;
addRect(ax1,0,ax2,ay2,3); addRect(gx1,0,gx2,gy2,3); addDot(cx,spot);
const ay1b=H-areaD, gy1b=H-goalD;
addRect(ax1,ay1b,ax2,H,3); addRect(gx1,gy1b,gx2,H,3); addDot(cx,H-spot);
const eps=0.03, base=Math.acos((areaD-spot)/R);
addCircle(cx,spot,R,base-eps,Math.PI-base+eps,260,3);
addCircle(cx,H-spot,R,Math.PI+base-eps,2*Math.PI-base+eps,260,3);

/* ====== DATI ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const DIST_GID = '116187224';  // distinta
const PUBLISHED_DIST_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=116187224&single=true';

const XI_NUMBERS   = [1,2,5,3,7,6,4,11,10,9,8];   // 3-4-1-2
const BENCH_NUMBERS= [12,13,14,15,16,17,18,19,20];

let coords3412 = [
  [34,107], // GK
  [54, 78], // RCB
  [34, 82], // CB
  [14, 78], // LCB
  [62, 52], // RWB
  [44, 57], // RCM
  [24, 57], // LCM
  [ 6, 52], // LWB
  [34, 36], // CAM
  [44, 13], // ST destro
  [24, 13]  // ST sinistro
];

/* helpers */
const gvizCsvURL  = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
function pubCsvURL(pubhtmlUrl){
  const u = new URL(pubhtmlUrl);
  const parts = u.pathname.split('/');
  const idIdx = parts.findIndex(p=>p==='e')+1;
  const id = parts[idIdx] || '';
  const root = `${u.protocol}//${u.host}${parts.slice(0,idIdx).join('/')}/${id}`;
  return `${root}/pub?gid=${encodeURIComponent(u.searchParams.get('gid')||'0')}&single=true&output=csv`;
}
function parseCSV(text){
  let t = String(text||'').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
  const lines = t.split('\n').filter((ln,i)=> i===0 || ln.trim().length>0);
  if (!lines.length) return [];
  const rows=[]; let row=[], cur='', inQ=false;
  const pushCell=()=>{ row.push(cur); cur=''; };
  const pushRow =()=>{ rows.push(row); row=[]; };
  const s = lines.join('\n');
  for (let i=0;i<s.length;i++){
    const c=s[i], n=s[i+1];
    if (inQ){
      if (c === '"' && n === '"'){ cur+='"'; i++; }
      else if (c === '"'){ inQ=false; }
      else { cur += c; }
    }else{
      if (c === '"'){ inQ=true; }
      else if (c === ','){ pushCell(); }
      else if (c === '\n'){ pushCell(); pushRow(); }
      else { cur += c; }
    }
  }
  if (cur!=='' || row.length) { pushCell(); pushRow(); }
  const header = rows.shift().map(h=>String(h||'').trim());
  return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i]!==undefined ? r[i] : '' ])));
}

async function fetchDistRows(){
  try{
    const res = await fetch(gvizCsvURL(SHEET_FILE_ID, DIST_GID), {cache:'no-store'});
    if (!res.ok) throw new Error('gviz '+res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if (rows.length) return rows;
  }catch(e){}
  const res = await fetch(pubCsvURL(PUBLISHED_DIST_URL), {cache:'no-store'});
  const txt = await res.text();
  return parseCSV(txt);
}

function normalizeDist(rows){
  if (!rows || !rows.length) return new Map();
  const keys = Object.keys(rows[0]);
  const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  let kNum = keys.find(k=>/#|num|numero|maglia/.test(norm(k))) || keys[0];
  let kName= keys.find(k=>/giocatore|player|nome|cognome/.test(norm(k))) || keys[1];
  let kPhoto=keys.find(k=>/foto|photo|img|immagine/.test(norm(k)));
  const map = new Map();
  rows.forEach(r=>{
    const n = Number(String(r[kNum]||'').trim());
    if(!(n>0)) return;
    map.set(n, { num:n, name: String(r[kName]||'').trim(), photo: String(r[kPhoto]||'').trim() });
  });
  return map;
}
const SURNAME = full => {
  const t=String(full||'').trim();
  if(!t) return '';
  const p=t.split(/\s+/);
  return p[p.length-1].toUpperCase();
};

/* ====== RENDER ====== */
function pct(n){ return (n/1000*100).toFixed(3)+'%'; }

function playerNode(obj, x, y){
  const div = document.createElement('div');
  div.className='player';
  div.style.left=pct(x); div.style.top=pct(y);

  const img = document.createElement('img');
  img.className='photo';
  img.alt = obj.name || '';
  if (obj.photo) {
    img.src = obj.photo;
    img.onerror = () => { img.onerror=null; img.src = `img/players/${obj.num}.png`; };
  } else {
    img.src = `img/players/${obj.num}.png`;
    img.onerror = () => img.remove();
  }
  div.appendChild(img);

  const badge = document.createElement('span');
  badge.className='badge';
  badge.textContent = `${obj.num}.${SURNAME(obj.name)}`;
  div.appendChild(badge);

  return div;
}

function render(byNum){
  const layer = document.getElementById('players');
  layer.innerHTML = '';

  XI_NUMBERS.forEach((n,i)=>{
    const p = byNum.get(n) || {num:n, name:''};
    const [ux,uy] = coords3412[i];
    const world = map( ux, uy );
    layer.appendChild( playerNode(p, world.x, world.y) );
  });

  const subs = BENCH_NUMBERS
    .map(n => {
      const p = byNum.get(n) || {num:n, name:''};
      return `${p.num}.${SURNAME(p.name)}`;
    })
    .join('  ');
  document.getElementById('subsList').textContent = subs;
}

/* ====== POSIZIONAMENTO SUBS: midpoint tra (angolo basso sx) e (bordo sx area × linea di fondo) ====== */
function placeSubsByPitch() {
  const el = document.getElementById('subsBadge');
  if (!el) return;
  const cx = W/2;
  const xAreaLeft = cx - areaW/2;  // bordo sinistro dell'area
  // punto A = angolo basso sinistro del campo: (u=0, v=H)
  const A = map(0, H);
  // punto B = intersezione bordo sx area con linea di fondo: (u=ax1, v=H)
  const B = map(xAreaLeft, H);
  // Midpoint fra A e B
  const Mx = (A.x + B.x) / 2;
  const leftPct = (Mx / 1000) * 100;
  el.style.left = leftPct.toFixed(3) + '%';
}

/* ==== GO! ==== */
(async function init(){
  try{
    const rows = await fetchDistRows();
    const byNum = normalizeDist(rows);
    render(byNum);
  }catch(e){
    console.error(e);
    render(new Map()); // mostra solo numeri
  }

  // posiziona SUBS e ricalcola al resize
  placeSubsByPitch();
  const stage = document.querySelector('.stage');
  if (window.ResizeObserver && stage) {
    const ro = new ResizeObserver(placeSubsByPitch);
    ro.observe(stage);
  } else {
    window.addEventListener('resize', placeSubsByPitch);
    window.addEventListener('orientationchange', placeSubsByPitch);
  }
})();
</script>
</body>
</html>
