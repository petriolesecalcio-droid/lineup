<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Campo in prospettiva + MATCHDAY + Foto sopra badge</title>
<style>
  :root{
    --pitch-bottom: 14%;     /* distanza del trapezio dal fondo */
    --subs-gap:      8%;     /* quanto spazio lasciare fra campo e panchina */
    --bg:#0b0c11;
    --roof-dark:#151923;
    --roof-mid:#1f2531;
    --roof-glow:rgba(255,255,255,.08);
    --grass-1:#0a6f20; --grass-2:#0d7f26;
    --rossoblu:linear-gradient(90deg,#8b0000,#000080);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:grid; place-items:center;
    font-family:system-ui,Arial,sans-serif;
  }

  .stage{
    position:relative;
    width:min(1200px,96vw);
    aspect-ratio:9/16;
    max-height:96vh;
    overflow:hidden;
    border-radius:18px;
    background:#0b0c11;
    box-shadow:0 25px 80px rgba(0,0,0,.6);
    container-type:inline-size;
  }

  .stadium{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 220px at 50% -40px, var(--roof-glow), transparent 60%),
      repeating-linear-gradient(-10deg, rgba(255,255,255,.05) 0 14px, rgba(0,0,0,0) 14px 44px),
      linear-gradient(to bottom, var(--roof-mid) 0%, var(--roof-dark) 48%, #061007 100%);
  }

  /* Trapezio del campo (clip SOLO per erba/linee) */
  .pitch-wrap{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    clip-path: polygon(12% 12%, 88% 12%, 100% 100%, 0 100%);
  }
  .grass{
    position:absolute; inset:0;
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.08) 0 6%, rgba(0,0,0,0) 6% 12%),
      linear-gradient(to bottom, var(--grass-2), var(--grass-1));
    box-shadow: inset 0 -40px 80px rgba(0,0,0,.35);
  }
  svg{position:absolute; inset:0; width:100%; height:100%;}

  /* Layer giocatori */
  .players{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    overflow:visible; pointer-events:none;
    container-type:inline-size;
  }
  .player{
    position:absolute;
    left:0; top:0;
    transform:translate(-50%, -100%);
    display:flex; flex-direction:column; align-items:center;
  }
  .player .photo{
    width:9cqw; height:auto; position:relative; z-index:1;
  }
  .badge{
    display:flex; align-items:center; justify-content:center;
    width:20cqw; aspect-ratio:5.5/1; margin-top:4px;
    background:url('badge.png?v=6') center/100% auto no-repeat;
    font-family:system-ui,Arial,sans-serif; font-weight:900;
    font-size:2cqw; color:#000; white-space:nowrap; line-height:1;
    pointer-events:none; position:relative; z-index:2;
  }

  /* MATCHDAY badge */
  .matchday-badge{
    position:absolute;
    top:2cqh; left:2cqw;
    padding:.8cqh 1.6cqw;
    background:var(--rossoblu);
    color:#fff; font-weight:700;
    font-size:clamp(1rem,2cqw,1.2rem);
    border-radius:.6cqw;
    letter-spacing:.3cqw;
  }

  /* SUBS: badge a cavallo, lista centrata sotto */
  .subs-badge{
    position:absolute;
    bottom:var(--pitch-bottom);
    transform:translateY(50%);         /* metà sopra, metà sotto */
    left:3cqw;
    padding:.5cqh 1cqw;
    background:var(--rossoblu);
    color:#fff; font-weight:700;
    font-size:clamp(.8rem,1.2cqw,.95rem);
    border-radius:.4cqw;
    min-width:10cqw; text-align:center;
    pointer-events:none;
    z-index:3;
    box-shadow:0 0 0 .2cqh rgba(0,0,0,.25);
  }

  .subs-list{
    position:absolute; left:0; right:0;

    /* occupa esattamente lo spazio sotto il campo */
    bottom:var(--subs-gap);
    height:calc(var(--pitch-bottom) - var(--subs-gap));

    display:flex; align-items:center; justify-content:center;

    color:#fff;
    font-size:clamp(.85rem,1.3cqw,1rem);
    text-align:center;
    padding:.5cqh 1cqw;
    word-break:break-word; overflow-wrap:anywhere;
    opacity:.95; letter-spacing:.2cqw;
  }
</style>
</head>
<body>
  <div class="stage">
    <div class="stadium"></div>

    <div class="matchday-badge">MATCHDAY</div>

    <!-- Campo (clip) -->
    <div class="pitch-wrap">
      <div class="grass"></div>
      <svg viewBox="0 0 1000 1000" preserveAspectRatio="none">
        <g id="lines" stroke="white" fill="none"></g>
      </svg>
    </div>

    <!-- Layer giocatori (NO clip, così escono dai bordi su mobile) -->
    <div class="players" id="players"></div>

    <!-- SUBS -->
    <div class="subs-badge">SUBS:</div>
    <div class="subs-list" id="subsList"></div>
  </div>

<script>
/* ====== DISEGNO CAMPO ====== */
const W=68,H=105,areaW=40.32,areaD=16.5,goalW=18.32,goalD=5.5,spot=11,R=9.15;
const TL={x:120,y:130}, TR={x:880,y:130}, BL={x:0,y:1000}, BR={x:1000,y:1000};
const lerp=(a,b,t)=>({x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t});
function map(u,v){const t=v/H, L=lerp(TL,BL,t), Rr=lerp(TR,BR,t), s=u/W; return {x:L.x+(Rr.x-L.x)*s, y:L.y+(Rr.y-L.y)*s};}
const G=document.getElementById('lines');
function addPolyline(pts,w=3){const el=document.createElementNS('http://www.w3.org/2000/svg','polyline'); el.setAttribute('points',pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ')); el.setAttribute('stroke','white'); el.setAttribute('fill','none'); el.setAttribute('stroke-width',w); el.setAttribute('stroke-linecap','round'); el.setAttribute('stroke-linejoin','round'); G.appendChild(el);}
const addLine=(u1,v1,u2,v2,w=3)=>addPolyline([map(u1,v1),map(u2,v2)],w);
function addRect(x1,y1,x2,y2,w=3){addLine(x1,y1,x2,y1,w); addLine(x1,y2,x2,y2,w); addLine(x1,y1,x1,y2,w); addLine(x2,y1,x2,y2,w);}
function addCircle(cx,cy,r,from,to,steps=240,w=3){const pts=[]; for(let i=0;i<=steps;i++){const a=from+(to-from)*i/steps; pts.push(map(cx+r*Math.cos(a),cy+r*Math.sin(a)));} addPolyline(pts,w);}
function addDot(u,v,r=2.2){const p=map(u,v); const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',r); c.setAttribute('fill','white'); G.appendChild(c);}
addPolyline([TL,TR,BR,BL,TL],6);
addLine(0,H/2,W,H/2,3);
addCircle(W/2,H/2,R,0,2*Math.PI,280,3); addDot(W/2,H/2);
const cx=W/2, ax1=cx-areaW/2, ax2=cx+areaW/2, ay2=areaD;
const gx1=cx-goalW/2, gx2=cx+goalW/2, gy2=goalD;
addRect(ax1,0,ax2,ay2,3); addRect(gx1,0,gx2,gy2,3); addDot(cx,spot);
const ay1b=H-areaD, gy1b=H-goalD;
addRect(ax1,ay1b,ax2,H,3); addRect(gx1,gy1b,gx2,H,3); addDot(cx,H-spot);
const eps=0.03, base=Math.acos((areaD-spot)/R);
addCircle(cx,spot,R,base-eps,Math.PI-base+eps,260,3);
addCircle(cx,H-spot,R,Math.PI+base-eps,2*Math.PI-base+eps,260,3);

/* ====== DATI ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const DIST_GID = '116187224';  // distinta
const PUBLISHED_DIST_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=116187224&single=true';

const XI_NUMBERS   = [1,2,5,3,7,6,4,11,10,9,8];   // 3-4-1-2
const BENCH_NUMBERS= [12,13,14,15,16,17,18,19,20];

const coords3412 = [
  [34,103], // GK
  [56, 87], // RCB
  [34, 90], // CB
  [12, 87], // LCB
  [62, 63], // RWB
  [44, 60], // RCM
  [24, 60], // LCM
  [ 6, 63], // LWB
  [34, 43], // CAM
  [44, 20], // ST destro
  [24, 20]  // ST sinistro
];

/* helpers */
const gvizCsvURL  = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
function pubCsvURL(pubhtmlUrl){
  const u = new URL(pubhtmlUrl);
  const parts = u.pathname.split('/');
  const idIdx = parts.findIndex(p=>p==='e')+1;
  const id = parts[idIdx] || '';
  const root = `${u.protocol}//${u.host}${parts.slice(0,idIdx).join('/')}/${id}`;
  return `${root}/pub?gid=${encodeURIComponent(u.searchParams.get('gid')||'0')}&single=true&output=csv`;
}
function parseCSV(text){
  let t = String(text||'').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
  const lines = t.split('\n').filter((ln,i)=> i===0 || ln.trim().length>0);
  if (!lines.length) return [];
  const rows=[]; let row=[], cur='', inQ=false;
  const pushCell=()=>{ row.push(cur); cur=''; };
  const pushRow =()=>{ rows.push(row); row=[]; };
  const s = lines.join('\n');
  for (let i=0;i<s.length;i++){
    const c=s[i], n=s[i+1];
    if (inQ){
      if (c === '"' && n === '"'){ cur+='"'; i++; }
      else if (c === '"'){ inQ=false; }
      else { cur += c; }
    }else{
      if (c === '"'){ inQ=true; }
      else if (c === ','){ pushCell(); }
      else if (c === '\n'){ pushCell(); pushRow(); }
      else { cur += c; }
    }
  }
  if (cur!=='' || row.length) { pushCell(); pushRow(); }
  const header = rows.shift().map(h=>String(h||'').trim());
  return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i]!==undefined ? r[i] : '' ])));
}

async function fetchDistRows(){
  // 1) GViz CSV
  try{
    const res = await fetch(gvizCsvURL(SHEET_FILE_ID, DIST_GID), {cache:'no-store'});
    if (!res.ok) throw new Error('gviz '+res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if (rows.length) return rows;
  }catch(e){}
  // 2) Pub CSV fallback
  const res = await fetch(pubCsvURL(PUBLISHED_DIST_URL), {cache:'no-store'});
  const txt = await res.text();
  return parseCSV(txt);
}

function normalizeDist(rows){
  if (!rows || !rows.length) return new Map();
  const keys = Object.keys(rows[0]);
  const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  let kNum = keys.find(k=>/#|num|numero|maglia/.test(norm(k))) || keys[0];
  let kName= keys.find(k=>/giocatore|player|nome|cognome/.test(norm(k))) || keys[1];
  let kPhoto=keys.find(k=>/foto|photo|img|immagine/.test(norm(k)));
  const map = new Map();
  rows.forEach(r=>{
    const n = Number(String(r[kNum]||'').trim());
    if(!(n>0)) return;
    map.set(n, {
      num:n,
      name: String(r[kName]||'').trim(),
      photo: String(r[kPhoto]||'').trim()
    });
  });
  return map;
}
const SURNAME = full => {
  const t=String(full||'').trim();
  if(!t) return '';
  const p=t.split(/\s+/);
  return p[p.length-1].toUpperCase();
};

/* ====== RENDER ====== */
function pct(n){ return (n/1000*100).toFixed(3)+'%'; }

function playerNode(obj, x, y){
  const div = document.createElement('div');
  div.className='player';
  div.style.left=pct(x); div.style.top=pct(y);

  // foto (se presente) sopra il badge
  const img = document.createElement('img');
  img.className='photo';
  img.alt = obj.name || '';

  if (obj.photo) {
    img.src = obj.photo;
    img.onerror = () => { img.onerror=null; img.src = `img/players/${obj.num}.png`; };
  } else {
    img.src = `img/players/${obj.num}.png`;
    img.onerror = () => img.remove();
  }
  div.appendChild(img);

  const badge = document.createElement('span');
  badge.className='badge';
  badge.textContent = `${obj.num}.${SURNAME(obj.name)}`;
  div.appendChild(badge);

  return div;
}

function render(byNum){
  const layer = document.getElementById('players');
  layer.innerHTML = '';

  XI_NUMBERS.forEach((n,i)=>{
    const p = byNum.get(n) || {num:n, name:''};
    const [ux,uy] = coords3412[i];
    const world = map(ux, uy);
    const node = playerNode(p, world.x, world.y);
    layer.appendChild(node);
  });

  // PANCHINA: senza virgole, stesso formato numero.COGNOME
  const subs = BENCH_NUMBERS
    .map(n => {
      const p = byNum.get(n) || {num:n, name:''};
      return `${p.num}.${SURNAME(p.name)}`;
    })
    .join('  ');
  document.getElementById('subsList').textContent = subs;
}

/* ==== GO! ==== */
(async function init(){
  try{
    const rows = await fetchDistRows();
    const byNum = normalizeDist(rows);
    render(byNum);
  }catch(e){
    console.error(e);
    render(new Map()); // mostra solo numeri
  }
})();
</script>
</body>
</html>
