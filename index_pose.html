<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Petriolese — Starting XI (Busti)</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<meta name="theme-color" content="#0b0f0c">
<link rel="preconnect" href="https://docs.google.com">
<link rel="dns-prefetch" href="https://docs.google.com">

<style>
  :root{
    --club-red:#e11d48; --club-blue:#1d4ed8;
    --bg:#0b0f0c; --text:#e5e7eb; --muted:#94a3b8;
    --plate:#ffffff; --plate-text:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}

  /* HEADER (logo + vs + avversario) */
  .topbar{
    display:flex;justify-content:center;align-items:center;gap:12px;
    padding:12px 14px;border-bottom:2px solid rgba(255,255,255,.08);
    background:linear-gradient(135deg,#0b0f0c 0%,#0f172a 60%,#0b0f0c 100%);
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:42px;height:42px;object-fit:contain}
  .brand .club{font-weight:900;white-space:nowrap}
  .vs-img{height:26px}
  .opponent{font-weight:900;text-transform:uppercase;white-space:nowrap}

  /* BACKDROP rossoblù + “stadio” astratto */
  .hero{
    background:
      radial-gradient(120% 80% at 20% 0%, rgba(225,29,72,.35), transparent 60%),
      radial-gradient(120% 80% at 80% 0%, rgba(29,78,216,.35), transparent 60%),
      linear-gradient(180deg,#0b0f0c 0%,#0b0f0c 100%);
    padding:16px 16px 28px;
  }

  /* CAMPO: pannello con linee bianche in overlay */
  .panel{
    width:100%; max-width:960px; margin:0 auto;
    border-radius:18px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(225,29,72,.14), rgba(29,78,216,.14));
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    overflow:hidden; position:relative;
  }
  .pitch{
    position:relative; width:100%; aspect-ratio:3/4; /* più “cinematografico” */
    background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.15));
    isolation:isolate;
  }
  .pitch::before{
    /* Linee campo SVG inline, sempre nitide */
    content:"";
    position:absolute; inset:0; opacity:.85; mix-blend-mode:screen; pointer-events:none;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 160" preserveAspectRatio="none"><defs><style>.l{stroke:%23fff;stroke-width:1.2;fill:none;}</style></defs><rect x="3" y="3" width="114" height="154" class="l"/><line x1="3" y1="80" x2="117" y2="80" class="l"/><circle cx="60" cy="80" r="10" class="l"/><rect x="30" y="3" width="60" height="22" class="l"/><rect x="40" y="3" width="40" height="8" class="l"/><rect x="30" y="135" width="60" height="22" class="l"/><rect x="40" y="149" width="40" height="8" class="l"/><circle cx="60" cy="15" r="1.2" fill="%23fff"/><circle cx="60" cy="145" r="1.2" fill="%23fff"/></svg>');
    background-size:cover; background-position:center;
  }

  /* STARTING XI badge */
  .starting{position:absolute; left:14px; top:14px; z-index:5;
    background:linear-gradient(90deg,var(--club-red),var(--club-blue));
    color:#fff; font-weight:900; font-size:12px; letter-spacing:.6px;
    padding:8px 12px; border-radius:999px; text-transform:uppercase;
    box-shadow:0 4px 12px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.25);
  }

  /* GIOCATORI (busto + targhetta) */
  .player{position:absolute; transform:translate(-50%,-50%); width:clamp(86px,14vw,140px); z-index:2; text-align:center}
  .bust{
    width:100%; aspect-ratio:1/1; border-radius:50%;
    overflow:hidden; border:3px solid rgba(255,255,255,.9);
    box-shadow:0 14px 30px rgba(0,0,0,.45), 0 0 0 10px rgba(15,23,42,.45);
    background:linear-gradient(135deg, rgba(225,29,72,.75), rgba(29,78,216,.75));
  }
  .bust img{width:100%; height:100%; object-fit:cover; object-position:50% 15%;}
  /* targhetta “brush” */
  .tag{
    position:relative; margin-top:6px; display:inline-block;
    color:var(--plate-text); font-weight:900; letter-spacing:.3px; text-transform:uppercase;
    padding:6px 12px; background:var(--plate);
    /* bordo grezzo con mask */
    -webkit-mask:
      radial-gradient(10px 8px at 8px 50%, #000 98%, transparent 101%) left center/14px 100%,
      radial-gradient(10px 8px at calc(100% - 8px) 50%, #000 98%, transparent 101%) right center/14px 100%,
      linear-gradient(#000 0 0) center/100% 100%;
    -webkit-mask-repeat:no-repeat;
            mask:
      radial-gradient(10px 8px at 8px 50%, #000 98%, transparent 101%) left center/14px 100%,
      radial-gradient(10px 8px at calc(100% - 8px) 50%, #000 98%, transparent 101%) right center/14px 100%,
      linear-gradient(#000 0 0) center/100% 100%;
    box-shadow:0 6px 16px rgba(0,0,0,.35);
  }

  /* BARRA PANCHINA in basso (testo scorrevole su mobile) */
  .benchbar{
    display:flex; align-items:center; gap:10px;
    border-top:1px solid rgba(255,255,255,.12);
    background:linear-gradient(90deg, rgba(225,29,72,.18), rgba(29,78,216,.18));
    padding:10px 12px; font-size:14px;
    overflow:auto; white-space:nowrap; scrollbar-width:none;
  }
  .benchbar::-webkit-scrollbar{display:none}
  .benchbar .label{font-weight:800; margin-right:8px; opacity:.9}
  .benchbar .name{opacity:.95}

  /* LAYOUT */
  .wrap{padding:16px 0 0}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img id="clubLogo" src="logo.png" alt="Logo Petriolese" onerror="this.style.display='none'"/>
    <div class="club">Petriolese Calcio</div>
  </div>
  <img class="vs-img" src="vs_battle.png" alt="VS" />
  <div id="opponent" class="opponent">AVVERSARIO</div>
</header>

<section class="hero">
  <div class="panel">
    <div class="pitch" id="pitch">
      <div class="starting">Starting XI</div>
      <!-- i giocatori vengono inseriti via JS -->
    </div>

    <!-- panchina in striscia -->
    <div class="benchbar" id="benchbar">
      <span class="label">Panchina:</span>
      <span class="name">carico…</span>
    </div>
  </div>

  <div class="wrap" id="notice" style="text-align:center;color:var(--muted);font-size:12px;">Carico i dati…</div>
</section>

<script>
/* ====== CONFIG: stessi Google Sheet ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const META_GID = '254048258';
const DIST_GID = '116187224';

/* Modulo 3-4-1-2 (percentuali su aspect 3:4) */
const XI_NUMBERS   = [1,2,5,3,7,6,4,11,10,9,8];
const coords3412 = [
  [50,90],  // POR
  [77,69],[50,72],[23,69], // 3
  [88,48],[62,52],[38,52],[12,48], // 4
  [50,34], // 1
  [68,17],[32,17] // 2 punte
];
const BENCH_NUMBERS = [12,13,14,15,16,17,18,19,20];

/* ====== HELPERS ====== */
const el = s => document.querySelector(s);
const gvizJsonURL = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:json`;

function parseGVizJSON(text){
  const start = text.indexOf('{'); const end = text.lastIndexOf('}');
  if (start<0 || end<0) throw new Error('JSON GViz non trovato');
  const json = JSON.parse(text.slice(start, end+1));
  const cols = json.table.cols.map(c => (c.label || c.id || '').toString().trim() || 'col');
  return json.table.rows.map(r=>{
    const obj={}; r.c.forEach((cell,i)=>{ obj[ cols[i] ] = (cell && cell.v!=null) ? String(cell.v) : ''; });
    return obj;
  });
}
async function fetchRows(gid){ const r=await fetch(gvizJsonURL(SHEET_FILE_ID,gid),{cache:'no-store'}); return parseGVizJSON(await r.text()); }
const surname = full => { const t=String(full||'').trim(); if(!t) return ''; const p=t.split(/\s+/); return p[p.length-1]; };

/* ====== RENDER ====== */
function render(metaRows, distRows){
  // META
  const meta = Object.fromEntries(metaRows.map(r=>[String(r.key||'').toLowerCase(), r.value||'']));
  el('#clubLogo').src = meta.logourl || 'logo.png';
  const opp = meta.avversario || 'AVVERSARIO';
  el('#opponent').textContent = opp;

  // DISTINTA
  // prova a indovinare colonne se i nomi sono diversi
  const sample = distRows[0] || {};
  const keys = Object.keys(sample);
  const keyFor = (alts) => keys.find(k=> alts.includes(k.toLowerCase())) || keys[0];
  const kNum   = keyFor(['num','numero','#','n']);
  const kName  = keyFor(['giocatore','nome','player','cognome','nomecognome']);
  const kPhoto = keyFor(['foto','photo','immagine','img','picture']);

  const byNum = new Map();
  distRows.forEach(r=>{
    const n = Number(r[kNum]); if(!n) return;
    byNum.set(n, { num:n, name:r[kName]||'', photo:r[kPhoto]||'' });
  });

  // XI in campo (busto + targhetta)
  const pitch = el('#pitch');
  pitch.querySelectorAll('.player').forEach(n=>n.remove());

  XI_NUMBERS.forEach((num,i)=>{
    const p = byNum.get(num) || {num, name:'', photo:''};
    const [x,y] = coords3412[i] || [50,50];

    const node = document.createElement('div');
    node.className = 'player';
    node.style.left = x+'%';
    node.style.top  = y+'%';

    const bust = document.createElement('div');
    bust.className = 'bust';
    if (p.photo){
      const img = document.createElement('img');
      img.src = p.photo; img.alt = p.name;
      img.onerror = ()=> img.remove();
      bust.appendChild(img);
    }
    node.appendChild(bust);

    const plate = document.createElement('div');
    plate.className = 'tag';
    plate.textContent = surname(p.name || '') || ('#'+num);
    node.appendChild(plate);

    pitch.appendChild(node);
  });

  // Panchina: riga di testi
  const benchbar = el('#benchbar');
  benchbar.innerHTML = '<span class="label">Panchina:</span>';
  const names = [];
  BENCH_NUMBERS.forEach(n=>{
    const p = byNum.get(n);
    if (p && p.name) names.push(surname(p.name));
  });
  names.push('All. Castellani');
  benchbar.insertAdjacentHTML('beforeend', names.map(n=>`<span class="name">${n}</span>`).join('<span class="name">, </span>'));

  el('#notice').textContent = 'Dati caricati';
}

/* ====== INIT ====== */
(async function(){
  try{
    const [metaRows, distRows] = await Promise.all([ fetchRows(META_GID), fetchRows(DIST_GID) ]);
    render(metaRows, distRows);
  }catch(err){
    console.error(err);
    el('#notice').textContent = 'Errore nel leggere i dati dagli Sheet.';
  }
})();
</script>
</body>
</html>
