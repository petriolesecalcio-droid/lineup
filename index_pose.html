<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matchday - Petriolese Calcio</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --pitch-bottom: 14%;
    --subs-gap:      8%;
    --bg:#0b0c11;
    --roof-dark:#151923;
    --roof-mid:#1f2531;
    --roof-glow:rgba(255,255,255,.08);
    --grass-1:#0a6f20; --grass-2:#0d7f26;

    /* === Giocatori (immutati) === */
    --photo-h: 20cqh;
    --badge-w: 16cqh;
    --badge-font: min(1.8cqh, 2.3cqw);
    --badge-overlap: 1.4cqh;

    /* === Testo elenco SUBS (immutati) === */
    --subs-font:  min(1.6cqh, 2.1cqw);
    --subs-weight: 800;
    --subs-tracking: .18cqw;
    --subs-line: 1.15;
    --subs-transform: uppercase;
    --subs-maxw: calc(100% - 6cqw);
    --subs-font-family: system-ui, Arial, sans-serif;

    /* ====== VARIABILI MODULABILI PER I DUE BADGE ====== */
    /* rapporto reale pennellata ~ 5.5:1 (adegua se usi un file diverso) */
    --brush-ar: 5.5;                 /* aspect ratio larghezza/altezza */

    /* MATCHDAY */
    --md-w: 36cqw;                   /* larghezza pennellata */
    --md-font: min(2.2cqh, 2.8cqw);  /* grandezza font */
    --md-x: 2cqw;                    /* offset sinistra */
    --md-y: 2cqh;                    /* offset alto */

    /* SUBS */
    --sb-w: 36cqw;                   /* larghezza pennellata */
    --sb-font: min(2cqh, 2.2cqw);  /* grandezza font */
    --sb-x: 2cqw;                    /* offset sinistra */
    --sb-gap-over: 0cqw;             /* ulteriore “sforamento” verso il campo (positivo = più dentro) */

    /* Effetti */
    --badge-shadow: 0 2px 10px rgba(0,0,0,.35);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:grid; place-items:center;
    font-family:system-ui,Arial,sans-serif;
  }

  .stage{
    position:relative;
    width:min(1200px,96vw);
    aspect-ratio:9/16;
    max-height:96vh;
    overflow:hidden;
    border-radius:18px;
    background:#0b0c11;
    box-shadow:0 25px 80px rgba(0,0,0,.6);
    container-type:size; /* abilita cqw + cqh */
  }

  .stadium{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 220px at 50% -40px, var(--roof-glow), transparent 60%),
      repeating-linear-gradient(-10deg, rgba(255,255,255,.05) 0 14px, rgba(0,0,0,0) 14px 44px),
      linear-gradient(to bottom, var(--roof-mid) 0%, var(--roof-dark) 48%, #061007 100%);
  }

  /* Campo in clip */
  .pitch-wrap{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    clip-path: polygon(12% 12%, 88% 12%, 100% 100%, 0 100%);
  }
  .grass{
    position:absolute; inset:0;
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.08) 0 6%, rgba(0,0,0,0) 6% 12%),
      linear-gradient(to bottom, var(--grass-2), var(--grass-1));
    box-shadow: inset 0 -40px 80px rgba(0,0,0,.35);
  }
  svg{position:absolute; inset:0; width:100%; height:100%;}

  /* Layer giocatori (no clip) */
  .players{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    overflow:visible; pointer-events:none;
    container-type:size;
  }

  .player{ position:absolute; left:0; top:0; transform:translate(-50%, -100%); }
  .player .photo{ height: var(--photo-h); width:auto; position:relative; display:block; z-index:1; }
  .badge{
    position:absolute; left:50%;
    top: calc(100% - var(--badge-overlap));
    transform: translateX(-50%);
    display:flex; align-items:center; justify-content:center;
    width: var(--badge-w);
    aspect-ratio: 5.5/1;
    font-size: var(--badge-font);
    font-weight: 900;
    background: url('badge.png?v=6') center/100% auto no-repeat; /* badge giocatore */
    color:#000; white-space:nowrap; line-height:1;
    pointer-events:none; z-index:2;
  }

  /* ====== BADGE GLOBALI CON PENNELLATA WEBP (completa) ====== */
  /* Nota: background-size: contain per mostrare TUTTO il PNG */
  .matchday-badge,
  .subs-badge{
    position:absolute;
    display:flex; align-items:center; justify-content:center;
    background: url('badge-bg.webp') center / contain no-repeat;
    filter: drop-shadow(var(--badge-shadow));
    text-transform: uppercase;
    letter-spacing:.18cqw;
    white-space:nowrap;
  }

  /* MATCHDAY: alto-sinistra */
  .matchday-badge{
    left: var(--md-x); top: var(--md-y);
    width: var(--md-w);
    height: calc(var(--md-w) / var(--brush-ar));
    font-weight: 900;
    font-size: var(--md-font);
    padding: 0 .8cqw;
    color:#fff;
  }

  /* SUBS: sinistra, a cavallo tra campo e panchina */
  .subs-badge{
    left: calc(var(--sb-x) + var(--sb-gap-over));
    bottom: var(--pitch-bottom);
    transform: translateY(50%);   /* metà sopra il bordo del campo */
    width: var(--sb-w);
    height: calc(var(--sb-w) / var(--brush-ar));
    font-weight: 900;
    font-size: var(--sb-font);
    padding: 0 .8cqw;
    color:#fff;
    z-index:3;
    pointer-events:none;
  }

  /* Zona elenco panchina */
  .subs-zone{
    position:absolute; left:0; right:0; bottom:0;
    height: var(--pitch-bottom);
    display:flex; align-items:center; justify-content:center;
    padding: 0 2cqw; pointer-events:none;
  }
  .subs-zone .subs-list{
    margin:0 auto; max-width: var(--subs-maxw);
    text-align:center; white-space:normal; overflow-wrap:anywhere;
    font-family: var(--subs-font-family);
    font-size: var(--subs-font);
    font-weight: var(--subs-weight);
    letter-spacing: var(--subs-tracking);
    line-height: var(--subs-line);
    text-transform: var(--subs-transform);
    color:#fff; opacity:.95;
  }

  @container (max-width: 520px){
    .stage{
      --subs-font: clamp(15px, 2.6cqh, 3.8cqw);
      --subs-tracking: .06cqw;
      --subs-maxw: calc(100% - 1cqw);
      /* Se vuoi ingrandire i badge su telefoni piccoli: */
      /* --md-w: 32cqw; --sb-w: 34cqw; */
    }
    .subs-zone{ padding: 0 1cqw; }
  }
</style>
</head>
<body>
  <div class="stage">
    <div class="stadium"></div>

    <!-- MATCHDAY (pennellata completa) -->
    <div class="matchday-badge">MATCHDAY</div>

    <!-- Campo (clip) -->
    <div class="pitch-wrap">
      <div class="grass"></div>
      <svg viewBox="0 0 1000 1000" preserveAspectRatio="none">
        <g id="lines" stroke="white" fill="none"></g>
      </svg>
    </div>

    <!-- Layer giocatori (NO clip) -->
    <div class="players" id="players"></div>

    <!-- SUBS (pennellata completa, sinistra, a cavallo) -->
    <div class="subs-badge">SUBS</div>

    <!-- Elenco panchina -->
    <div class="subs-zone">
      <div class="subs-list" id="subsList"></div>
    </div>
  </div>

<script>
/* ====== DISEGNO CAMPO ====== */
const W=68,H=105,areaW=40.32,areaD=16.5,goalW=18.32,goalD=5.5,spot=11,R=9.15;
const TL={x:120,y:130}, TR={x:880,y:130}, BL={x:0,y:1000}, BR={x:1000,y:1000};
const lerp=(a,b,t)=>({x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t});
function map(u,v){const t=v/H, L=lerp(TL,BL,t), Rr=lerp(TR,BR,t), s=u/W; return {x:L.x+(Rr.x-L.x)*s, y:L.y+(Rr.y-L.y)*s};}
const G=document.getElementById('lines');
function addPolyline(pts,w=3){const el=document.createElementNS('http://www.w3.org/2000/svg','polyline'); el.setAttribute('points',pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ')); el.setAttribute('stroke','white'); el.setAttribute('fill','none'); el.setAttribute('stroke-width',w); el.setAttribute('stroke-linecap','round'); el.setAttribute('stroke-linejoin','round'); G.appendChild(el);}
const addLine=(u1,v1,u2,v2,w=3)=>addPolyline([map(u1,v1),map(u2,v2)],w);
function addRect(x1,y1,x2,y2,w=3){addLine(x1,y1,x2,y1,w); addLine(x1,y2,x2,y2,w); addLine(x1,y1,x1,y2,w); addLine(x2,y1,x2,y2,w);}
function addCircle(cx,cy,r,from,to,steps=240,w=3){const pts=[]; for(let i=0;i<=steps;i++){const a=from+(to-from)*i/steps; pts.push(map(cx+r*Math.cos(a),cy+r*Math.sin(a)));} addPolyline(pts,w);}
function addDot(u,v,r=2.2){const p=map(u,v); const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',r); c.setAttribute('fill','white'); G.appendChild(c);}
addPolyline([TL,TR,BR,BL,TL],6);
addLine(0,H/2,W,H/2,3);
addCircle(W/2,H/2,R,0,2*Math.PI,280,3); addDot(W/2,H/2);
const cx=W/2, ax1=cx-areaW/2, ax2=cx+areaW/2, ay2=areaD;
const gx1=cx-goalW/2, gx2=cx+goalW/2, gy2=goalD;
addRect(ax1,0,ax2,ay2,3); addRect(gx1,0,gx2,gy2,3); addDot(cx,spot);
const ay1b=H-areaD, gy1b=H-goalD;
addRect(ax1,ay1b,ax2,H,3); addRect(gx1,gy1b,gx2,H,3); addDot(cx,H-spot);
const eps=0.03, base=Math.acos((areaD-spot)/R);
addCircle(cx,spot,R,base-eps,Math.PI-base+eps,260,3);
addCircle(cx,H-spot,R,Math.PI+base-eps,2*Math.PI-base+eps,260,3);

/* ====== DATI ====== */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const DIST_GID = '116187224';
const PUBLISHED_DIST_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpJqXmoJaIznEo_EGHCfUxyYVWWKJCGULM9FbnI14hLhGpsjt3oMHT5ahJwEmJ4w/pubhtml?gid=116187224&single=true';

const XI_NUMBERS   = [1,2,5,3,7,6,4,11,10,9,8];   // 3-4-1-2
const BENCH_NUMBERS= [12,13,14,15,16,17,18,19,20];

let coords3412 = [
  [34,107], [54,78], [34,82], [14,78],
  [62,52], [44,57], [24,57], [6,52],
  [34,36], [44,13], [24,13]
];

/* helpers */
const gvizCsvURL  = (fileId, gid) => `https://docs.google.com/spreadsheets/d/${fileId}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
function pubCsvURL(pubhtmlUrl){
  const u = new URL(pubhtmlUrl);
  const parts = u.pathname.split('/');
  const idIdx = parts.findIndex(p=>p==='e')+1;
  const id = parts[idIdx] || '';
  const root = `${u.protocol}//${u.host}${parts.slice(0,idIdx).join('/')}/${id}`;
  return `${root}/pub?gid=${encodeURIComponent(u.searchParams.get('gid')||'0')}&single=true&output=csv`;
}
function parseCSV(text){
  let t = String(text||'').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
  const lines = t.split('\n').filter((ln,i)=> i===0 || ln.trim().length>0);
  if (!lines.length) return [];
  const rows=[]; let row=[], cur='', inQ=false;
  const pushCell=()=>{ row.push(cur); cur=''; };
  const pushRow =()=>{ rows.push(row); row=[]; };
  const s = lines.join('\n');
  for (let i=0;i<s.length;i++){
    const c=s[i], n=s[i+1];
    if (inQ){
      if (c === '"' && n === '"'){ cur+='"'; i++; }
      else if (c === '"'){ inQ=false; }
      else { cur += c; }
    }else{
      if (c === '"'){ inQ=true; }
      else if (c === ','){ pushCell(); }
      else if (c === '\n'){ pushCell(); pushRow(); }
      else { cur += c; }
    }
  }
  if (cur!=='' || row.length) { pushCell(); pushRow(); }
  const header = rows.shift().map(h=>String(h||'').trim());
  return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i]!==undefined ? r[i] : '' ])));
}

async function fetchDistRows(){
  try{
    const res = await fetch(gvizCsvURL(SHEET_FILE_ID, DIST_GID), {cache:'no-store'});
    if (!res.ok) throw new Error('gviz '+res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if (rows.length) return rows;
  }catch(e){}
  const res = await fetch(pubCsvURL(PUBLISHED_DIST_URL), {cache:'no-store'});
  const txt = await res.text();
  return parseCSV(txt);
}

function normalizeDist(rows){
  if (!rows || !rows.length) return new Map();
  const keys = Object.keys(rows[0]);
  const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  let kNum = keys.find(k=>/#|num|numero|maglia/.test(norm(k))) || keys[0];
  let kName= keys.find(k=>/giocatore|player|nome|cognome/.test(norm(k))) || keys[1];
  let kPhoto=keys.find(k=>/foto|photo|img|immagine/.test(norm(k)));
  const map = new Map();
  rows.forEach(r=>{
    const n = Number(String(r[kNum]||'').trim());
    if(!(n>0)) return;
    map.set(n, { num:n, name: String(r[kName]||'').trim(), photo: String(r[kPhoto]||'').trim() });
  });
  return map;
}
const SURNAME = full => {
  const t=String(full||'').trim();
  if(!t) return '';
  const p=t.split(/\s+/);
  return p[p.length-1].toUpperCase();
};

/* ====== RENDER ====== */
function pct(n){ return (n/1000*100).toFixed(3)+'%'; }

function playerNode(obj, x, y){
  const div = document.createElement('div');
  div.className='player';
  div.style.left=pct(x); div.style.top=pct(y);

  const img = document.createElement('img');
  img.className='photo';
  img.alt = obj.name || '';
  if (obj.photo) {
    img.src = obj.photo;
    img.onerror = () => { img.onerror=null; img.src = `img/players/${obj.num}.png`; };
  } else {
    img.src = `img/players/${obj.num}.png`;
    img.onerror = () => img.remove();
  }
  div.appendChild(img);

  const badge = document.createElement('span');
  badge.className='badge';
  badge.textContent = `${obj.num}.${SURNAME(obj.name)}`;
  div.appendChild(badge);

  return div;
}

function render(byNum){
  const layer = document.getElementById('players');
  layer.innerHTML = '';

  XI_NUMBERS.forEach((n,i)=>{
    const p = byNum.get(n) || {num:n, name:''};
    const [ux,uy] = coords3412[i];
    const world = map( ux, uy );
    layer.appendChild( playerNode(p, world.x, world.y) );
  });

  const subs = BENCH_NUMBERS
    .map(n => {
      const p = byNum.get(n) || {num:n, name:''};
      return `${p.num}.${SURNAME(p.name)}`;
    })
    .join('  ');
  document.getElementById('subsList').textContent = subs;
}

/* ==== GO! ==== */
(async function init(){
  try{
    const rows = await fetchDistRows();
    const byNum = normalizeDist(rows);
    render(byNum);
  }catch(e){
    console.error(e);
    render(new Map()); // mostra solo numeri
  }
})();
</script>
</body>
</html>
