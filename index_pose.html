<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Petriolese — Matchday</title>
<meta name="theme-color" content="#0b0f0c">

<link rel="preconnect" href="https://docs.google.com">
<link rel="dns-prefetch" href="https://docs.google.com">

<style>
  :root{
    --club-red:#e11d48; --club-blue:#1d4ed8;
    --bg:#0b0f0c; --text:#e5e7eb;
    --line:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:start center}

  /* Header “MATCHDAY” */
  .matchday-badge{
    position:fixed; left:clamp(14px,3vw,26px); top:clamp(12px,2.5vw,22px); z-index:10;
    background:linear-gradient(90deg,var(--club-red),var(--club-blue));
    color:#fff; font-weight:900; letter-spacing:.4px; font-size:12px;
    padding:6px 10px; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,.35);
  }

  /* Stage / stadio */
  .stage{
    width:min(1180px,96vw); aspect-ratio:16/10; max-height:96vh;
    position:relative; margin-top:44px;
    border-radius:18px; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,.6);
    background:#0b0c11;
  }
  .roof{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 220px at 50% -40px, rgba(255,255,255,.07), transparent 60%),
      radial-gradient(600px 200px at 12% 0, rgba(255,255,255,.06), transparent 70%),
      radial-gradient(600px 200px at 88% 0, rgba(255,255,255,.06), transparent 70%),
      repeating-linear-gradient(-10deg, rgba(255,255,255,.06) 0 14px, rgba(0,0,0,0) 14px 44px),
      linear-gradient(to bottom, #1f2531 0%, #151923 48%, #061007 100%);
  }
  .roof::after{content:"";position:absolute;inset:0;background:radial-gradient(120% 90% at 50% 8%, transparent 0 60%, rgba(0,0,0,.55) 100%)}

  /* Trapezio campo (più stretto in alto) */
  .pitch-wrap{
    position:absolute; left:50%; bottom:0; transform:translateX(-50%);
    width:100%; height:70%;
    clip-path: polygon(12% 6%, 88% 6%, 100% 100%, 0 100%);
  }
  /* Erba con tagli orizzontali */
  .grass{
    position:absolute; inset:0;
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.08) 0 6%, rgba(0,0,0,0) 6% 12%),
      linear-gradient(#0d7f26, #0a6f20);
    box-shadow: inset 0 -40px 80px rgba(0,0,0,.35);
  }
  /* Linee campo in SVG (inserite via script) */
  svg{position:absolute; inset:0; width:100%; height:100%}

  /* Badge SUBS dentro al campo */
  .subs-badge{
    position:absolute; left:14px; bottom:14px; z-index:6;
    background:linear-gradient(90deg,var(--club-red),var(--club-blue));
    color:#fff; font-weight:900; font-size:10px; padding:6px 10px; border-radius:8px;
    box-shadow:0 3px 8px rgba(0,0,0,.35);
  }

  /* Titolari: badge “numero. COGNOME” */
  .player{
    position:absolute; transform:translate(-50%,-50%); z-index:7;
  }
  .chip{
    --bg:#fff; --txt:#111;
    background:var(--bg); color:var(--txt);
    border-radius:999px; padding:6px 10px;
    font-weight:900; font-size:12px; letter-spacing:.2px; white-space:nowrap;
    box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.08);
  }

  /* Panchina sotto al campo */
  .bench-line{
    width:100%; text-align:center; margin-top:10px;
    font-weight:700; font-size:14px; line-height:1.3;
  }
  .bench-line .label{font-weight:900; padding:4px 8px; border-radius:8px; color:#fff; margin-right:6px;
    background:linear-gradient(90deg,var(--club-red),var(--club-blue));}
  .bench-wrap{width:min(1180px,96vw); margin-inline:auto; margin-top:6px}
</style>
</head>
<body>

<div class="matchday-badge">MATCHDAY</div>

<section class="stage" id="stage">
  <div class="roof"></div>

  <div class="pitch-wrap" id="pitchWrap">
    <div class="grass"></div>
    <svg viewBox="0 0 1000 1000" preserveAspectRatio="none">
      <g id="fieldLines" stroke="#ffffff" fill="none"></g>
    </svg>

    <!-- badge SUBS dentro al campo -->
    <div class="subs-badge">SUBS:</div>

    <!-- qui lo script inserisce i titolari .player -->
  </div>
</section>

<div class="bench-wrap">
  <div class="bench-line" id="benchLine">
    <span class="label">SUBS:</span>
    <span id="benchText">caricamento…</span>
  </div>
</div>

<script>
/* =======================
   1) CAMPO IN PROSPETTIVA
   ======================= */
const TL = {x:120, y:110}, TR = {x:880, y:110}, BL = {x:0, y:1000}, BR = {x:1000, y:1000};
const Wm = 68, Hm = 105; // misure “logiche” del campo

const lerp=(a,b,t)=>({x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t});
function map(u,v){ // u:0..Wm, v:0..Hm
  const t=v/Hm, L=lerp(TL,BL,t), R=lerp(TR,BR,t), s=u/Wm;
  return {x:L.x+(R.x-L.x)*s, y:L.y+(R.y-L.y)*s};
}
function addPolyline(parent, pts, w=3){
  const el=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  el.setAttribute('points', pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' '));
  el.setAttribute('stroke-width', w); el.setAttribute('stroke-linecap','round'); el.setAttribute('stroke-linejoin','round');
  parent.appendChild(el);
}
function addLine(parent, u1,v1,u2,v2,w=3){ addPolyline(parent,[map(u1,v1),map(u2,v2)],w); }
function addRect(parent, x1,y1,x2,y2,w=3){ addLine(parent,x1,y1,x2,y1,w); addLine(parent,x1,y2,x2,y2,w); addLine(parent,x1,y1,x1,y2,w); addLine(parent,x2,y1,x2,y2,w); }
function addCircle(parent, cx,cy,r, from=0, to=2*Math.PI, steps=160, w=3){
  const pts=[]; for(let i=0;i<=steps;i++){ const a=from+(to-from)*i/steps; pts.push(map(cx+r*Math.cos(a), cy+r*Math.sin(a))); }
  addPolyline(parent, pts, w);
}
(function drawField(){
  const g=document.getElementById('fieldLines');
  const areaW=40.32, areaD=16.5, goalW=18.32, goalD=5.5, spot=11, R=9.15;

  // perimetro = trapezio
  addPolyline(g,[TL,TR,BR,BL,TL],6);

  // metà campo
  addLine(g,0,Hm/2, Wm,Hm/2,3);
  addCircle(g, Wm/2,Hm/2, R, 0, 2*Math.PI, 180, 4);

  // area e 5.5 top
  const ax1=(Wm-areaW)/2, ax2=(Wm+areaW)/2, ay2=areaD;
  const gx1=(Wm-goalW)/2, gx2=(Wm+goalW)/2, gy2=goalD;
  addRect(g, ax1,0, ax2,ay2,3);
  addRect(g, gx1,0, gx2,gy2,3);
  addCircle(g, Wm/2, spot, R, 0, Math.PI, 120, 3); // arco verso il centro

  // area e 5.5 bottom
  addRect(g, ax1,Hm-ay2, ax2,Hm,3);
  addRect(g, gx1,Hm-gy2, gx2,Hm,3);
  addCircle(g, Wm/2, Hm-spot, R, Math.PI, 2*Math.PI, 120, 3); // arco verso il centro
})();

/* ============================================
   2) COORDINATE MODULO 3-4-1-2 (percentuali campo)
   ============================================ */
const coords3412 = [
  // GK
  [50,90],
  // D3
  [20,66],[50,70],[80,66],
  // M4
  [12,47],[38,47],[62,47],[88,47],
  // AM
  [50,35],
  // ST2
  [38,16],[62,16],
];

/* ============================================
   3) LETTURA GOOGLE SHEETS (stessi link dell’index “pallini”)
   ============================================ */
const SHEET_FILE_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const META_GID  = '254048258';
const DIST_GID  = '116187224';

const gvizJsonURL=(id,gid)=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:json`;
const gvizCsvURL =(id,gid)=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?gid=${encodeURIComponent(gid)}&headers=1&tqx=out:csv`;
function parseCSV(text){
  let t=String(text||'').replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n'); while(t.startsWith('\n')) t=t.slice(1);
  const lines=t.split('\n').filter((ln,i)=>i===0||ln.trim().length>0); if(!lines.length) return [];
  const rows=[]; let row=[],cur='',inQ=false; const pushC=()=>{row.push(cur);cur='';}; const pushR=()=>{rows.push(row);row=[];};
  const s=lines.join('\n');
  for(let i=0;i<s.length;i++){ const c=s[i],n=s[i+1];
    if(inQ){ if(c=='"'&&n=='"'){cur+='"';i++;} else if(c=='"'){inQ=false;} else cur+=c; }
    else { if(c=='"'){inQ=true;} else if(c==','){pushC();} else if(c=='\n'){pushC();pushR();} else cur+=c; }
  }
  if(cur!==''||row.length){pushC();pushR();}
  const header=rows.shift().map(h=>String(h||'').trim());
  return rows.filter(r=>r.some(v=>String(v||'').trim()!=='')).map(r=>Object.fromEntries(header.map((h,i)=>[h, r[i]??''])));
}
function parseGVizJSON(text){
  const a=text.indexOf('{'), b=text.lastIndexOf('}'); const json=JSON.parse(text.slice(a,b+1));
  const cols=json.table.cols.map(c=>(c.label||c.id||'').toString().trim()||'col');
  return json.table.rows.map(r=>{const o={}; r.c.forEach((c,i)=>o[cols[i]||('col'+(i+1))]=(c&&c.v!=null)?String(c.v):''); return o;});
}
async function fetchRows(gid){
  try{
    const r=await fetch(gvizJsonURL(SHEET_FILE_ID,gid),{cache:'no-store'}); const t=await r.text();
    const rows=parseGVizJSON(t); if(rows.length) return rows;
  }catch(e){}
  const r2=await fetch(gvizCsvURL(SHEET_FILE_ID,gid),{cache:'no-store'}); const t2=await r2.text(); return parseCSV(t2);
}

/* Helpers distinta */
function normalizeDist(rows){
  if(!rows?.length) return new Map();
  const keys=Object.keys(rows[0]);
  const norm=s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]/g,'');
  let kNum=keys.find(k=>['num','numero','n','#','maglia','shirt'].includes(norm(k)));
  let kName=keys.find(k=>['nome','cognome','giocatore','player','nomecognome'].includes(norm(k)));
  const score=Object.fromEntries(keys.map(k=>[k,{num:0,txt:0}]));
  rows.forEach(r=>{
    keys.forEach(k=>{ const v=String(r[k]??'').trim(); if(/^\d{1,2}$/.test(v))score[k].num++; if(/[A-Za-zÀ-ÿ]/.test(v))score[k].txt++;});
  });
  if(!kNum) kNum=keys.reduce((a,b)=>score[a].num>=score[b].num?a:b);
  if(!kName) kName=keys.filter(k=>k!==kNum).reduce((a,b)=>score[a].txt>=score[b].txt?a:b);
  const map=new Map();
  rows.forEach(r=>{
    const n=Number(String(r[kNum]||'').trim()); if(!(n>0)) return;
    const nm=String(r[kName]||'').trim(); map.set(n,{num:n,name:nm});
  });
  return map;
}
const cognome = full => {const t=String(full||'').trim(); if(!t) return ''; const p=t.split(/\s+/); return p[p.length-1].toUpperCase();};

/* ============================================
   4) RENDER: titolari (chip) + panchina (testo)
   ============================================ */
const XI = [1,2,5,3,7,6,4,11,10,9,8];         // 3-4-1-2
const BENCH = [12,13,14,15,16,17,18,19,20];   // 9 panchinari

function putPlayers(byNum){
  // pulizia
  document.querySelectorAll('.player').forEach(n=>n.remove());

  const wrap = document.getElementById('pitchWrap');
  XI.forEach((num,i)=>{
    const p = byNum.get(num) || {num, name:''};
    const [xp,yp] = coords3412[i] || [50,50];

    const d=document.createElement('div');
    d.className='player'; d.style.left= xp+'%'; d.style.top= yp+'%';

    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent = `${num}. ${cognome(p.name)}`;
    d.appendChild(chip);

    wrap.appendChild(d);
  });
}

function putBench(byNum){
  const arr = BENCH
    .map(n => {
      const p = byNum.get(n) || {num:n, name:''};
      const s = cognome(p.name) || '';
      return `${n} ${s}`.trim();
    });
  document.getElementById('benchText').textContent = arr.join(', ');
}

/* Boot */
(async function init(){
  try{
    const distRows = await fetchRows(DIST_GID);
    const byNum = normalizeDist(distRows);
    putPlayers(byNum);
    putBench(byNum);
  }catch(e){
    console.error(e);
    document.getElementById('benchText').textContent = 'Dati non disponibili';
  }
})();
</script>
</body>
</html>
