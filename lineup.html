<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matchday - Petriolese Calcio</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --pitch-bottom: 14%;
    --subs-gap:      8%;
    --bg:#0b0c11;
    --roof-dark:#151923;
    --roof-mid:#1f2531;
    --roof-glow:rgba(255,255,255,.08);

    --grass-1:#0a6f20; --grass-2:#0d7f26;

    /* Giocatori / badge */
    --photo-h: 20cqh;
    --badge-w: 17cqh;
    --badge-font: min(1.8cqh, 2.3cqw);
    --badge-overlap: 1.4cqh;

    /* SUBS (elenco) */
    --subs-font:  min(1.6cqh, 2.1cqw);
    --subs-weight: 800;
    --subs-tracking: .18cqw;
    --subs-line: 1.15;
    --subs-transform: uppercase;
    --subs-maxw: calc(100% - 6cqw);
    --subs-font-family: system-ui, Arial, sans-serif;

    /* MATCHDAY */
    --md-w: 88cqw;
    --md-font-top: 3.6cqw;
    --md-font-sub: 2.2cqw;
    --md-splat-bleed: 2.2cqh;

    /* VS */
    --vs-w: 88cqw;
    --vs-logo-h: 10cqh;
    --vs-gap: 2cqw;
    --vs-font: 2.2cqw;
    --vs-letter: .18cqw;

    /* FABs */
    --fab-stack-gap: clamp(8px, 1.6cqw, 12px);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:grid; place-items:center;
    font-family:system-ui,Arial,sans-serif;
  }

  .stage{
    position:relative;
    width:min(1200px,96vw);
    aspect-ratio:9/16;
    max-height:96vh;
    overflow:hidden;
    border-radius:18px;
    background:#0b0c11;
    box-shadow:0 25px 80px rgba(0,0,0,.6);
    container-type:size;
  }

  /* Fondale */
  .stadium{
    position:absolute; inset:0; z-index:0;
    background:
      radial-gradient(1200px 220px at 50% -40px, var(--roof-glow), transparent 60%),
      linear-gradient(to bottom, var(--roof-mid) 0%, var(--roof-dark) 48%, #061007 100%);
  }
  .roof-stripes{ position:absolute; inset:0; z-index:1; pointer-events:none; display:block; }

  /* Campo */
  .pitch-wrap{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%; z-index:2;
  }
  #pitch{ position:absolute; inset:0; width:100%; height:100%; display:block; }
  .pitch-rect{ fill:url(#grass); stroke:#fff; stroke-width:2; opacity:.98; }
  .pitch-lines{ stroke:#fff; stroke-width:2; fill:none; opacity:.95; }

  /* Layer giocatori */
  .players{
    position:absolute; left:50%; bottom:var(--pitch-bottom); transform:translateX(-50%);
    width:100%; height:75%;
    overflow:visible; pointer-events:none; z-index:3;
  }
  .player{ position:absolute; left:0; top:0; transform:translate(-50%, -100%); display:block; overflow:visible; }
  .player .photo{ height: var(--photo-h); width:auto; position:relative; display:block; z-index:1; }
  .badge{
    position:absolute; left:50%; top: calc(100% - var(--badge-overlap)); transform: translateX(-50%);
    text-transform: uppercase; display:flex; align-items:center; justify-content:center;
    width: var(--badge-w); aspect-ratio: 5.5/1;
    font-size: var(--badge-font); font-weight: 900;
    background: url('badge.png?v=6') center/100% auto no-repeat;
    color:#000; white-space:nowrap; line-height:1; pointer-events:none; z-index:2;
    text-shadow: 0 1px 0 rgba(255,255,255,.25);
  }

  /* MATCHDAY + competizione (come countdown) */
  .matchday-badge{
    position:absolute; left:50%; top: 18%; transform: translate(-50%, -50%);
    width: var(--md-w); aspect-ratio: 5.5/1;
    display:flex; align-items:center; justify-content:center;
    background:none; overflow:visible; pointer-events:none; z-index:4;
  }
  .matchday-badge::before{
    content:""; position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);
    width:100%; height: calc(100% + var(--md-splat-bleed) * 2);
    background: url('md-splat.webp?v=3') center / contain no-repeat; z-index:-1; pointer-events:none;
  }
  .matchday-text{ display:flex; flex-direction:column; align-items:center; gap:.35cqh; color:#fff; font-weight:900; text-transform:uppercase; letter-spacing:.22cqw; line-height:1.05; text-align:center; }
  .matchday-text .md-top{ font-size: var(--md-font-top); }
  .matchday-text .md-sub{ font-size: var(--md-font-sub); letter-spacing:.18cqw; }
  .matchday-text .md-comp{ font-size: var(--md-font-sub); letter-spacing:.18cqw; opacity:.95; }
  .matchday-text .md-comp[hidden]{ display:none; }
  @container (max-width: 520px){
    .matchday-text .md-comp{ font-size: clamp(14px, 3.2cqw, 22px); letter-spacing:.16cqw; }
  }

  /* VS */
  .versus{
    position:absolute; left:50%; top: 29%; transform:translateX(-50%);
    width: var(--vs-w); display:flex; align-items:center; justify-content:space-between;
    gap: var(--vs-gap); color:#fff; z-index:4; text-transform:uppercase; font-weight:900; letter-spacing: var(--vs-letter);
  }
  .team{ display:flex; align-items:center; gap:1cqw; }
  .team img{ height: var(--vs-logo-h); width:auto; object-fit:contain; filter: drop-shadow(0 2px 8px rgba(0,0,0,.4)); }
  .vs-core{ font-size: clamp(22px, var(--vs-font), 42px); opacity:.95; }

  /* Sostituti */
  .subs{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom: calc(var(--pitch-bottom) - 8%);
    width: var(--subs-maxw);
    color:#fff; text-transform: var(--subs-transform);
    font-weight: var(--subs-weight);
    letter-spacing: var(--subs-tracking);
    line-height: var(--subs-line);
    font-size: var(--subs-font);
    font-family: var(--subs-font-family);
    text-align:center;
    filter: drop-shadow(0 2px 10px rgba(0,0,0,.45));
    z-index:4;
  }

  /* FAB */
  .fab-stack{ position:absolute; right: 2cqw; bottom: 2cqh; display:flex; flex-direction:column; gap: var(--fab-stack-gap); z-index:5; }
  .fab{ width: 48px; height: 48px; border-radius:50%; background:#1e293b; color:#fff; display:grid; place-items:center; box-shadow:0 10px 25px rgba(0,0,0,.45); font-size:18px; user-select:none; }
</style>
</head>
<body>
  <div class="stage">
    <div class="stadium"></div>

    <svg class="roof-stripes" viewBox="0 0 1000 1778" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <pattern id="diag" patternUnits="userSpaceOnUse" width="44" height="44" patternTransform="rotate(-10)">
          <rect x="0" y="0" width="44" height="14" fill="#ffffff" opacity="0.06"/>
          <rect x="0" y="14" width="44" height="30" fill="transparent"/>
        </pattern>
      </defs>
      <rect x="0" y="0" width="1000" height="1778" fill="url(#diag)"/>
    </svg>

    <!-- MATCHDAY con competizione (sotto) -->
    <div id="matchdayBadge" class="matchday-badge">
      <div class="matchday-text">
        <div class="md-top">MATCHDAY</div>
        <div class="md-sub" id="mdSub"></div>
        <div class="md-comp" id="mdComp" hidden></div>
      </div>
    </div>

    <!-- VS -->
    <div class="versus" id="versus" aria-hidden="true" hidden>
      <div class="team" id="team1"><img id="logo1" alt="Logo Squadra 1" /><span id="name1"></span></div>
      <div class="vs-core">VS</div>
      <div class="team" id="team2"><span id="name2"></span><img id="logo2" alt="Logo Squadra 2" /></div>
    </div>

    <!-- Campo -->
    <div class="pitch-wrap">
      <svg id="pitch" viewBox="0 0 1000 1400" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <defs>
          <linearGradient id="grass" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%"  stop-color="var(--grass-1)"/>
            <stop offset="100%" stop-color="var(--grass-2)"/>
          </linearGradient>
        </defs>
        <rect x="60" y="60" width="880" height="1280" rx="18" class="pitch-rect"/>
        <g class="pitch-lines">
          <rect x="60" y="60" width="880" height="1280" rx="18" fill="none"/>
          <line x1="60" y1="700" x2="940" y2="700"/>
          <circle cx="500" cy="700" r="70"/>
          <circle cx="500" cy="700" r="4" fill="#fff"/>
          <rect x="60"  y="460" width="170" height="440"/>
          <rect x="770" y="460" width="170" height="440"/>
          <rect x="60"  y="570" width="60"  height="260"/>
          <rect x="880" y="570" width="60"  height="260"/>
          <rect x="45"  y="630" width="15" height="140"/>
          <rect x="940" y="630" width="15" height="140"/>
        </g>
      </svg>
    </div>

    <!-- Giocatori -->
    <div class="players" id="playersLayer"></div>

    <!-- Sostituti -->
    <div class="subs" id="subsText"></div>

    <!-- FAB -->
    <div class="fab-stack">
      <div class="fab" title="Refresh" id="refreshBtn">⟳</div>
    </div>
  </div>

<script>
/* ====== CONFIG FOGLIO GOOGLE ====== */
const SHEET_ID = '1nWG0OBGpiyK-lulP-OKGad4jG7uEVmcy';
const GID_META  = '254048258';   // "Meta" (Giornata, Squadra 1/2, Competizione, Modulo)
const GID_DIST  = '116187224';   // "Distinta/giocatori"
const GID_OPP   = '1284472120';  // "Avversari" (Squadra, Logo)

/* ====== FETCH CSV ====== */
const csvUrl = (gid) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;

async function fetchCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Fetch CSV failed '+res.status);
  const text = await res.text();
  return parseCSV(text);
}
function parseCSV(text){
  const rows = text.replace(/\r/g,'').split('\n').filter(Boolean).map(r=>splitCsvLine(r));
  const headers = rows.shift().map(h=>h.trim());
  return rows.map(cols=>{
    const obj={};
    headers.forEach((h,i)=>obj[h]= (cols[i]??'').trim());
    return obj;
  });
}
function splitCsvLine(line){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i], n=line[i+1];
    if(c=='"' && n=='"'){ cur+='"'; i++; continue; }
    if(c=='"'){ inQ=!inQ; continue; }
    if(c==',' && !inQ){ out.push(cur); cur=''; continue; }
    cur+=c;
  }
  out.push(cur);
  return out;
}

/* ====== DATA ====== */
async function fetchMetaRows(){ return fetchCSV(csvUrl(GID_META)); }
async function fetchDistRows(){ return fetchCSV(csvUrl(GID_DIST)); }
async function fetchOppRows(){  return fetchCSV(csvUrl(GID_OPP));  }

function normalizeMeta(metaRows){
  const map = new Map();
  for(const r of metaRows){
    for(const [k,v] of Object.entries(r)){
      const key = (k||'').toString().trim().toLowerCase();
      const val = (v||'').toString().trim();
      if(!key) continue;
      if(key==='chiave' && r['valore']){
        map.set(r['chiave'].toString().trim().toLowerCase(), r['valore'].toString().trim());
      }else{
        if(['giornata','squadra 1','squadra1','squadra 2','squadra2','competizione','modulo','modulo tattico'].includes(key)){
          map.set(key, val);
        }
      }
    }
  }
  return map;
}
function normalizeOpp(oppRows){
  const m = new Map();
  for(const r of oppRows){
    const s = (r['Squadra']||r['squadra']||'').trim();
    const l = (r['Logo']||r['logo']||'').trim();
    if(s) m.set(s, l);
  }
  return m;
}
function normalizeDist(rows){
  const byNum = new Map();
  for(const r of rows){
    const num  = (r['Numero']||r['N']||r['#']||'').toString().trim();
    const cog  = (r['Cognome']||r['COGNOME']||'').toString().trim();
    const nome = (r['Nome']||r['NOME']||'').toString().trim();
    const ruol = (r['Ruolo']||r['RUOLO']||'').toString().trim();
    const tit  = (r['Titolare']||r['TITOLARE']||'').toString().trim().toLowerCase();
    const foto = (r['Foto']||r['FOTO']||'').toString().trim();
    if(!num && !cog) continue;
    byNum.set(num || cog, { num, cognome:cog, nome, ruolo:ruol, titolare: (tit==='si' || tit==='sì' || tit==='yes' || tit==='1' ), foto });
  }
  return byNum;
}

/* ====== RENDER ====== */
const playersLayer = document.getElementById('playersLayer');
const subsText     = document.getElementById('subsText');

const FORMATIONS = {
  '3412': [
    {x:50,y:95, ruolo:'P'},
    {x:20,y:72, ruolo:'D'},{x:50,y:70, ruolo:'D'},{x:80,y:72, ruolo:'D'},
    {x:18,y:56, ruolo:'C'},{x:40,y:48, ruolo:'C'},{x:60,y:48, ruolo:'C'},{x:82,y:56, ruolo:'C'},
    {x:50,y:36, ruolo:'T'},
    {x:35,y:22, ruolo:'A'},{x:65,y:22, ruolo:'A'}
  ]
};

function render(byNum, moduloRaw){
  playersLayer.innerHTML = '';
  const modulo = (moduloRaw || '3412').replace(/\s/g,'');
  const slots = FORMATIONS[modulo] || FORMATIONS['3412'];

  const starters = pickStarters(byNum);
  while(starters.length < 11) starters.push({num:'', cognome:'', ruolo:'', foto:''});

  starters.slice(0,11).forEach((pl,i)=>{
    const pos = slots[i] || {x:50,y:50};
    addPlayerNode(pl, pos.x, pos.y);
  });

  const bench = [...byNum.values()].filter(p=>!p.titolare);
  subsText.textContent = bench.length ? 'PANCHINA: ' + bench.map(b=>fmtPlayer(b)).join('  •  ') : '';

  document.getElementById('versus').hidden = false;
  document.getElementById('versus').setAttribute('aria-hidden','false');
}

function fmtPlayer(p){
  const n = p.num ? `${p.num}.` : '';
  return `${n}${(p.cognome||'').toUpperCase()}`.trim();
}
function addPlayerNode(p, xPct, yPct){
  const el = document.createElement('div');
  el.className = 'player';
  el.style.left = xPct + '%';
  el.style.top  = yPct + '%';

  const img = document.createElement('img');
  img.className = 'photo';
  img.alt = `${p.nome||''} ${p.cognome||''}`.trim();
  img.src = p.foto || 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';
  el.appendChild(img);

  const badge = document.createElement('div');
  badge.className = 'badge';
  badge.textContent = fmtPlayer(p) || '—';
  el.appendChild(badge);

  playersLayer.appendChild(el);
}

/* ====== MATCHDAY / VS ====== */
function setLogo(imgEl, src, alt){
  if(!imgEl) return;
  imgEl.src = src;
  imgEl.alt = alt||'';
}
function resolveLogoSrc(squadra, oppMap){
  const s = (squadra||'').trim();
  if(!s) return 'logos/petriolese.webp';
  if(oppMap && oppMap.get(s)) return oppMap.get(s);
  const slug = s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'').replace(/^$/,'squadra');
  return `logos/${slug}.webp`;
}

/* ====== PICK STARTERS ====== */
function pickStarters(byNum){
  const arr = [...byNum.values()];
  const starters = arr.filter(p=>p.titolare);
  if(starters.length===0){
    const P = arr.filter(p=>/^p(e|o|)\b/i.test(p.ruolo)||/port/i.test(p.ruolo)).slice(0,1);
    const others = arr.filter(p=>!P.includes(p)).slice(0,10);
    return [...P, ...others];
  }
  const order = (r) => /^p/i.test(r)?0:/^d/i.test(r)?1:/^c|m/i.test(r)?2:/^t/i.test(r)?3:/^a|f/i.test(r)?4:5;
  return starters.sort((a,b)=>order(a.ruolo)-order(b.ruolo)).slice(0,11);
}

/* ====== INIT ====== */
async function init(){
  const mdSubEl  = document.getElementById('mdSub');
  const mdCompEl = document.getElementById('mdComp');
  const name1El  = document.getElementById('name1');
  const name2El  = document.getElementById('name2');

  try{
    const [distRows, metaRows, oppRows] = await Promise.all([
      fetchDistRows(), fetchMetaRows(), fetchOppRows()
    ]);

    const byNum = normalizeDist(distRows);
    const meta  = normalizeMeta(metaRows);
    const opp   = normalizeOpp(oppRows);

    const moduloRaw = (meta.get('modulo') || meta.get('modulo tattico') || '3412').toString().trim();
    render(byNum, moduloRaw);

    const giornata     = (meta.get('giornata') || '').toString().trim();
    const competizione = (meta.get('competizione') || '').toString().trim();
    const squadra1     = (meta.get('squadra 1') || meta.get('squadra1') || 'Petriolese').toString().trim() || 'Petriolese';
    const squadra2     = (meta.get('squadra 2') || meta.get('squadra2') || '').toString().trim();

    /* === LOGICA COME COUNTDOWN === */
    if (competizione.toLowerCase() === 'amichevole'){
      mdSubEl.textContent = 'AMICHEVOLE';
      mdCompEl.textContent = '';
      mdCompEl.hidden = true;
    } else if (competizione === 'Terza Cat. Girone E'){
      mdSubEl.textContent  = giornata ? `GIORNATA ${giornata}` : '';
      mdCompEl.textContent = 'Terza Cat. Girone E';
      mdCompEl.hidden = false;
    } else {
      mdSubEl.textContent  = giornata ? `GIORNATA ${giornata}` : '';
      if (competizione){
        mdCompEl.textContent = competizione;
        mdCompEl.hidden = false;
      } else {
        mdCompEl.textContent = '';
        mdCompEl.hidden = true;
      }
    }

    /* VS */
    name1El.textContent = squadra1;
    name2El.textContent = squadra2 || '—';
    setLogo(document.getElementById('logo1'), resolveLogoSrc(squadra1, opp), squadra1);
    setLogo(document.getElementById('logo2'), resolveLogoSrc(squadra2, opp), squadra2);

  }catch(e){
    console.error('Errore dati sheet, uso fallback demo:', e);

    // Fallback demo
    const demo = new Map([
      ['1',{num:'1', cognome:'TABORRI', ruolo:'P', titolare:true}],
      ['2',{num:'2', cognome:'ROSSI', ruolo:'D', titolare:true}],
      ['3',{num:'3', cognome:'MALVESTITI', ruolo:'D', titolare:true}],
      ['4',{num:'4', cognome:'BELLESI', ruolo:'D', titolare:true}],
      ['5',{num:'5', cognome:'RUGGERI', ruolo:'C', titolare:true}],
      ['6',{num:'6', cognome:'LISI', ruolo:'C', titolare:true}],
      ['7',{num:'7', cognome:'CIURLANTI', ruolo:'C', titolare:true}],
      ['8',{num:'8', cognome:'PIERANTONI', ruolo:'C', titolare:true}],
      ['10',{num:'10', cognome:'TREQUARTISTA', ruolo:'T', titolare:true}],
      ['9',{num:'9', cognome:'PRIMA PUNTA', ruolo:'A', titolare:true}],
      ['11',{num:'11', cognome:'ALA', ruolo:'A', titolare:true}],
      ['12',{num:'12', cognome:'SUB1', ruolo:'P', titolare:false}],
      ['13',{num:'13', cognome:'SUB2', ruolo:'D', titolare:false}],
    ]);
    render(demo, '3412');

    document.getElementById('mdSub').textContent = 'AMICHEVOLE';
    const mdCompEl = document.getElementById('mdComp');
    mdCompEl.textContent = '';
    mdCompEl.hidden = true;

    document.getElementById('name1').textContent = 'Petriolese';
    document.getElementById('name2').textContent = 'Moglianese';
    setLogo(document.getElementById('logo1'), 'logos/petriolese.webp', 'Petriolese');
    setLogo(document.getElementById('logo2'), 'logos/moglianese.webp', 'Moglianese');
  }

  layoutFABs();
}
function layoutFABs(){ document.getElementById('refreshBtn').onclick = ()=>location.reload(); }

init();
</script>
</body>
</html>
